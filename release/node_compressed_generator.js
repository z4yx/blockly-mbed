// Do not edit this file; automatically generated by nodejs node_compress_generator.js
 'use strict';

/*
 Licensed under the Apache License, Version 2.0 (the "License"):
          http://www.apache.org/licenses/LICENSE-2.0
*/
Blockly.mbed=new Blockly.Generator("mbed");Blockly.mbed.StaticTyping=new Blockly.StaticTyping;
Blockly.mbed.addReservedWords("Blockly,"+"setup,loop,if,else,for,switch,case,while,do,break,continue,return,goto,"+"define,include,HIGH,LOW,INPUT,OUTPUT,INPUT_PULLUP,true,false,integer,"+"constants,floating,point,void,boolean,char,unsigned,byte,int,word,long,"+"float,double,string,String,array,static,volatile,const,sizeof,pinMode,"+"digitalWrite,digitalRead,analogReference,analogRead,analogWrite,tone,"+"noTone,shiftOut,shitIn,pulseIn,millis,micros,delay,delayMicroseconds,"+"min,max,abs,constrain,map,pow,sqrt,sin,cos,tan,randomSeed,random,"+
"lowByte,highByte,bitRead,bitWrite,bitSet,bitClear,bit,attachInterrupt,"+"detachInterrupt,interrupts,noInterrupts");Blockly.mbed.ORDER_ATOMIC=0;Blockly.mbed.ORDER_UNARY_POSTFIX=1;Blockly.mbed.ORDER_MEMBER=1.2;Blockly.mbed.ORDER_UNARY_PREFIX=2;Blockly.mbed.ORDER_MULTIPLICATIVE=3;Blockly.mbed.ORDER_ADDITIVE=4;Blockly.mbed.ORDER_SHIFT=5;Blockly.mbed.ORDER_RELATIONAL=6;Blockly.mbed.ORDER_EQUALITY=7;Blockly.mbed.ORDER_BITWISE_AND=8;Blockly.mbed.ORDER_BITWISE_XOR=9;Blockly.mbed.ORDER_BITWISE_OR=10;
Blockly.mbed.ORDER_LOGICAL_AND=11;Blockly.mbed.ORDER_LOGICAL_OR=12;Blockly.mbed.ORDER_CONDITIONAL=13;Blockly.mbed.ORDER_ASSIGNMENT=14;Blockly.mbed.ORDER_COMMA=17;Blockly.mbed.ORDER_NONE=99;Blockly.mbed.PinTypes={INPUT:"INPUT",OUTPUT:"OUTPUT",PWM:"PWM",SERVO:"SERVO",STEPPER:"STEPPER",SERIAL:"SERIAL",I2C:"I2C/TWI",SPI:"SPI"};Blockly.mbed.DEF_FUNC_NAME=Blockly.mbed.FUNCTION_NAME_PLACEHOLDER_;
Blockly.mbed.init=function(workspace){Blockly.mbed.includes_=Object.create(null);Blockly.mbed.definitions_=Object.create(null);Blockly.mbed.variables_=Object.create(null);Blockly.mbed.codeFunctions_=Object.create(null);Blockly.mbed.userFunctions_=Object.create(null);Blockly.mbed.functionNames_=Object.create(null);Blockly.mbed.setups_=Object.create(null);Blockly.mbed.pins_=Object.create(null);if(!Blockly.mbed.variableDB_)Blockly.mbed.variableDB_=new Blockly.Names(Blockly.mbed.RESERVED_WORDS_);else Blockly.mbed.variableDB_.reset();
var varsWithTypes=Blockly.mbed.StaticTyping.collectVarsWithTypes(workspace);Blockly.mbed.StaticTyping.setProcedureArgs(workspace,varsWithTypes);for(var varName in varsWithTypes){var v=workspace.getVariableById(varName);if(v===null)continue;var name=v.name;var decl=Blockly.mbed.getmbedType_(varsWithTypes[varName]);if(varsWithTypes[varName].typeId===Blockly.Types.ARRAY.typeId)decl=decl.replace(/\[/,name+"[");else decl+=" "+name;Blockly.mbed.addVariable(varName,decl+";")}};
Blockly.mbed.finish=function(code){var includes=["#define HIGH 1","#define LOW 0",'#include "mbed.h"',"#include \x3cstring\x3e","typedef bool boolean;","typedef std::string String;"],definitions=[],variables=[],functions=[];for(var name in Blockly.mbed.includes_)includes.push(Blockly.mbed.includes_[name]);if(includes.length)includes.push("\n");for(var name in Blockly.mbed.variables_)variables.push(Blockly.mbed.variables_[name]);if(variables.length)variables.push("\n");for(var name in Blockly.mbed.definitions_)definitions.push(Blockly.mbed.definitions_[name]);
if(definitions.length)definitions.push("\n");for(var name in Blockly.mbed.codeFunctions_)functions.push(Blockly.mbed.codeFunctions_[name]);for(var name in Blockly.mbed.userFunctions_)functions.push(Blockly.mbed.userFunctions_[name]);if(functions.length)functions.push("\n");var setups=[""],userSetupCode="";if(Blockly.mbed.setups_["userSetupCode"]!==undefined){userSetupCode="\n"+Blockly.mbed.setups_["userSetupCode"];delete Blockly.mbed.setups_["userSetupCode"]}for(var name in Blockly.mbed.setups_)setups.push(Blockly.mbed.setups_[name]);
if(userSetupCode)setups.push(userSetupCode);delete Blockly.mbed.includes_;delete Blockly.mbed.definitions_;delete Blockly.mbed.codeFunctions_;delete Blockly.mbed.userFunctions_;delete Blockly.mbed.functionNames_;delete Blockly.mbed.setups_;delete Blockly.mbed.pins_;Blockly.mbed.variableDB_.reset();var allDefs=includes.join("\n")+variables.join("\n")+definitions.join("\n")+functions.join("\n\n");var setup=setups.join("\n");var loop="int main() {\n  "+setup+"\n\n"+code.replace(/\n/g,"\n  ")+"\n}";return allDefs+
loop};Blockly.mbed.addInclude=function(includeTag,code){if(Blockly.mbed.includes_[includeTag]===undefined)Blockly.mbed.includes_[includeTag]=code};Blockly.mbed.addDeclaration=function(declarationTag,code){if(Blockly.mbed.definitions_[declarationTag]===undefined)Blockly.mbed.definitions_[declarationTag]=code};
Blockly.mbed.addVariable=function(varName,code,overwrite){var overwritten=false;if(overwrite||Blockly.mbed.variables_[varName]===undefined){var codeSplit=code.split(/\s+/);if(codeSplit.length==4)code=codeSplit[0]+" "+codeSplit[3].replace(";","")+"[]\x3d"+codeSplit[2]+";";Blockly.mbed.variables_[varName]=code;overwritten=true}return overwritten};
Blockly.mbed.addSetup=function(setupTag,code,overwrite){var overwritten=false;if(overwrite||Blockly.mbed.setups_[setupTag]===undefined){Blockly.mbed.setups_[setupTag]=code;overwritten=true}return overwritten};
Blockly.mbed.addFunction=function(preferedName,code){if(Blockly.mbed.codeFunctions_[preferedName]===undefined){var uniqueName=Blockly.mbed.variableDB_.getDistinctName(preferedName,Blockly.Generator.NAME_TYPE);Blockly.mbed.codeFunctions_[preferedName]=code.replace(Blockly.mbed.DEF_FUNC_NAME,uniqueName);Blockly.mbed.functionNames_[preferedName]=uniqueName}return Blockly.mbed.functionNames_[preferedName]};
Blockly.mbed.reservePin=function(block,pin,pinType,warningTag){if(Blockly.mbed.pins_[pin]!==undefined)if(Blockly.mbed.pins_[pin]!=pinType)block.setWarningText(Blockly.Msg.MBED_PIN_WARN1.replace("%1",pin).replace("%2",warningTag).replace("%3",pinType).replace("%4",Blockly.mbed.pins_[pin]),warningTag);else block.setWarningText(null,warningTag);else{Blockly.mbed.pins_[pin]=pinType;block.setWarningText(null,warningTag)}};Blockly.mbed.scrubNakedValue=function(line){return line+";\n"};
Blockly.mbed.quote_=function(string){string=string.replace(/\\/g,"\\\\").replace(/\n/g,"\\\n").replace(/\$/g,"\\$").replace(/'/g,"\\'");var hexStr="";try{var gbk=GBK.encode(string);console.debug(gbk);var hexArr=gbk.map(function(n){if(n>=32&&n<128)return String.fromCharCode(n);var h=n.toString(16);if(h.length==1)h="0"+h;return"\\x"+h});hexStr=hexArr.join("")}catch(e){console.error(e)}return'"'+hexStr+'"'};
Blockly.mbed.scrub_=function(block,code){if(code===null)return"";var commentCode="";if(!block.outputConnection||!block.outputConnection.targetConnection){var comment=block.getCommentText();if(comment)commentCode+=this.prefixLines(comment,"// ")+"\n";for(var x=0;x<block.inputList.length;x++)if(block.inputList[x].type==Blockly.INPUT_VALUE){var childBlock=block.inputList[x].connection.targetBlock();if(childBlock){var comment=this.allNestedComments(childBlock);if(comment)commentCode+=this.prefixLines(comment,
"// ")}}}var nextBlock=block.nextConnection&&block.nextConnection.targetBlock();var nextCode=this.blockToCode(nextBlock);return commentCode+code+nextCode};
Blockly.mbed.getmbedType_=function(typeBlockly){switch(typeBlockly.typeId){case Blockly.Types.SHORT_NUMBER.typeId:return"char";case Blockly.Types.NUMBER.typeId:return"int";case Blockly.Types.LARGE_NUMBER.typeId:return"long";case Blockly.Types.DECIMAL.typeId:return"float";case Blockly.Types.TEXT.typeId:return"String";case Blockly.Types.CHARACTER.typeId:return"char";case Blockly.Types.BOOLEAN.typeId:return"boolean";case Blockly.Types.NULL.typeId:return"void";case Blockly.Types.UNDEF.typeId:return"undefined";
case Blockly.Types.CHILD_BLOCK_MISSING.typeId:return"int";case Blockly.Types.ARRAY.typeId:return Blockly.mbed.getmbedType_(typeBlockly.typeAtom)+" ["+typeBlockly.typeLength+"]"+" "+typeBlockly.typeContent;case Blockly.Blocks.filesystem.FilePointer.typeId:return"FILE*";default:return"Invalid Blockly Type"}};Blockly.mbed.getVariableName=function(block,varID,OBSOLETE){var v=block.workspace.getVariableById(varID);if(v===null)return"";return v.name};
Blockly.mbed.getVariableType=function(block,varID){var varsWithTypes=Blockly.mbed.StaticTyping.collectVarsWithTypes(block.workspace);for(var v in varsWithTypes)if(v==varID)return varsWithTypes[v];return null};Blockly.mbed.noGeneratorCodeInline=function(){return["",Blockly.mbed.ORDER_ATOMIC]};Blockly.mbed.noGeneratorCodeLine=function(){return""};
Blockly.mbed.getAdjusted=function(block,atId,opt_delta,opt_negate,opt_order){var delta=opt_delta||0;var order=opt_order||Blockly.mbed.ORDER_NONE;if(block.workspace.options.oneBasedIndex)delta--;var defaultAtIndex=block.workspace.options.oneBasedIndex?"1":"0";if(delta>0)var at=Blockly.mbed.valueToCode(block,atId,Blockly.mbed.ORDER_ADDITIVE)||defaultAtIndex;else if(delta<0)var at=Blockly.mbed.valueToCode(block,atId,Blockly.mbed.ORDER_ADDITIVE)||defaultAtIndex;else if(opt_negate)var at=Blockly.mbed.valueToCode(block,
atId,Blockly.mbed.ORDER_UNARY_PREFIX)||defaultAtIndex;else var at=Blockly.mbed.valueToCode(block,atId,order)||defaultAtIndex;if(Blockly.isNumber(at)){at=parseFloat(at)+delta;if(opt_negate)at=-at}else{if(delta>0){at=at+" + "+delta;var innerOrder=Blockly.mbed.ORDER_ADDITIVE}else if(delta<0){at=at+" - "+-delta;var innerOrder=Blockly.mbed.ORDER_ADDITIVE}if(opt_negate){if(delta)at="-("+at+")";else at="-"+at;var innerOrder=Blockly.mbed.ORDER_UNARY_PREFIX}innerOrder=Math.floor(innerOrder);order=Math.floor(order);
if(innerOrder&&order>=innerOrder)at="("+at+")"}return at};/*
 Licensed under the Apache License, Version 2.0 (the "License"):
          http://www.apache.org/licenses/LICENSE-2.0
 < Window WatchDog Interrupt                             < PVD through EXTI Line detection Interrupt             < Tamper Interrupt                                      < RTC global Interrupt                                  < FLASH global Interrupt                                < RCC global Interrupt                                  < EXTI Line0 Interrupt                                  < EXTI Line1 Interrupt                                  < EXTI Line2 Interrupt                                  < EXTI Line3 Interrupt                                  < EXTI Line4 Interrupt                                  < DMA1 Channel 1 global Interrupt                       < DMA1 Channel 2 global Interrupt                       < DMA1 Channel 3 global Interrupt                       < DMA1 Channel 4 global Interrupt                       < DMA1 Channel 5 global Interrupt                       < DMA1 Channel 6 global Interrupt                       < DMA1 Channel 7 global Interrupt                       < ADC1 and ADC2 global Interrupt                        < USB Device High Priority or CAN1 TX Interrupts        < USB Device Low Priority or CAN1 RX0 Interrupts        < CAN1 RX1 Interrupt                                    < CAN1 SCE Interrupt                                    < External Line[9:5] Interrupts                         < TIM1 Break Interrupt                                  < TIM1 Update Interrupt                                 < TIM1 Trigger and Commutation Interrupt                < TIM1 Capture Compare Interrupt                        < TIM2 global Interrupt                                 < TIM3 global Interrupt                                 < TIM4 global Interrupt                                 < I2C1 Event Interrupt                                  < I2C1 Error Interrupt                                  < I2C2 Event Interrupt                                  < I2C2 Error Interrupt                                  < SPI1 global Interrupt                                 < SPI2 global Interrupt                                 < USART1 global Interrupt                               < USART2 global Interrupt                               < USART3 global Interrupt                               < External Line[15:10] Interrupts                       < RTC Alarm through EXTI Line Interrupt                 < USB Device WakeUp from suspend through EXTI Line Interrupt */
Blockly.mbed.boards={};Blockly.mbed.Boards=new Object;Blockly.mbed.Boards["profiles"]=new Object;Blockly.mbed.Boards["generateAnalogIo"]=function(pinStart,pinEnd){var analogIo=[];for(var i=pinStart;i<pinEnd+1;i++)analogIo.push(["A"+i.toString(),"A"+i.toString()]);return analogIo};
Blockly.mbed.Boards["profiles"]["nucleo_f103rb"]={name:"NUCLEO F103RB",description:"mbed NUCLEO standard compatible board",digitalPins:[["PA_0","PA_0"],["PA_1","PA_1"],["PA_10","PA_10"],["PA_11","PA_11"],["PA_12","PA_12"],["PA_13","PA_13"],["PA_14","PA_14"],["PA_15","PA_15"],["PA_2","PA_2"],["PA_3","PA_3"],["PA_4","PA_4"],["PA_5","PA_5"],["PA_6","PA_6"],["PA_7","PA_7"],["PA_8","PA_8"],["PA_9","PA_9"],["PB_0","PB_0"],["PB_1","PB_1"],["PB_10","PB_10"],["PB_11","PB_11"],["PB_12","PB_12"],["PB_13","PB_13"],
["PB_14","PB_14"],["PB_15","PB_15"],["PB_2","PB_2"],["PB_3","PB_3"],["PB_4","PB_4"],["PB_5","PB_5"],["PB_6","PB_6"],["PB_7","PB_7"],["PB_8","PB_8"],["PB_9","PB_9"],["PC_0","PC_0"],["PC_1","PC_1"],["PC_10","PC_10"],["PC_11","PC_11"],["PC_12","PC_12"],["PC_13","PC_13"],["PC_14","PC_14"],["PC_15","PC_15"],["PC_2","PC_2"],["PC_3","PC_3"],["PC_4","PC_4"],["PC_5","PC_5"],["PC_6","PC_6"],["PC_7","PC_7"],["PC_8","PC_8"],["PC_9","PC_9"],["PD_2","PD_2"],["PF_0","PF_0"],["PF_1","PF_1"]],analogPins:[["PA_0",
"PA_0"],["PA_1","PA_1"],["PA_2","PA_2"],["PA_3","PA_3"],["PA_4","PA_4"],["PA_5","PA_5"],["PA_6","PA_6"],["PA_7","PA_7"],["PB_0","PB_0"],["PB_1","PB_1"],["PC_0","PC_0"],["PC_1","PC_1"],["PC_2","PC_2"],["PC_3","PC_3"],["PC_4","PC_4"],["PC_5","PC_5"]],pwmPins:[["PA_1","PA_1"],["PA_10","PA_10"],["PA_11","PA_11"],["PA_15","PA_15"],["PA_2","PA_2"],["PA_3","PA_3"],["PA_6","PA_6"],["PA_7","PA_7"],["PA_8","PA_8"],["PA_9","PA_9"],["PB_0","PB_0"],["PB_1","PB_1"],["PB_10","PB_10"],["PB_11","PB_11"],["PB_13",
"PB_13"],["PB_14","PB_14"],["PB_15","PB_15"],["PB_3","PB_3"],["PB_4","PB_4"],["PB_5","PB_5"],["PC_4","PC_4"],["PC_6","PC_6"],["PC_7","PC_7"],["PC_8","PC_8"],["PC_9","PC_9"]],serialPinsRX:[["PA_10","PA_10"],["PA_3","PA_3"],["PB_11","PB_11"],["PB_7","PB_7"],["PC_11","PC_11"]],serialPinsTX:[["PB_6","PB_6"],["PC_10","PC_10"],["PA_9","PA_9"],["PB_10","PB_10"],["PA_2","PA_2"]],serialPins:[["Serial_1","Serial_1"],["Serial_2","Serial_2"],["Serial_3","Serial_3"]],serialMapper:{"PC_10":"Serial_3","PB_7":"Serial_1",
"PC_11":"Serial_3","PB_6":"Serial_1","PA_9":"Serial_1","PB_10":"Serial_3","PA_10":"Serial_1","PA_2":"Serial_2","PA_3":"Serial_2","PB_11":"Serial_3"},serialSpeed:[["9600","9600"],["300","300"],["600","600"],["1200","1200"],["2400","2400"],["4800","4800"],["14400","14400"],["19200","19200"],["28800","28800"],["31250","31250"],["38400","38400"],["57600","57600"],["115200","115200"]],spi:[["SPI2","SPI2"],["SPI1","SPI1"]],spi1_choice:[["PA_5,PA_6,PA_7","PA_5,PA_6,PA_7"],["PB_3,PB_4,PB_5","PB_3,PB_4,PB_5"]],
spi1_alternative:{"MOSI":"PB_5","MISO":"PB_4","SCK":"PB_3"},spiPins:{SPI1:{"MOSI":"PA_7","MISO":"PA_6","SCK":"PA_5"},SPI2:{"MOSI":"PB_15","MISO":"PB_14","SCK":"PB_13"}},i2cMapper:{"PB_6":"I2C_1","PB_7":"I2C_1","PB_8":"I2C_1","PB_9":"I2C_1","PB_10":"I2C_2","PB_11":"I2C_2"},i2cPins:[["I2C_1","I2C_1"],["I2C_2","I2C_2"]],i2cPinsSDA:[["PB_9","PB_9"],["PB_11","PB_11"],["PB_7","PB_7"]],i2cPinsSCL:[["PB_8","PB_8"],["PB_10","PB_10"],["PB_6","PB_6"]],i2cSpeed:[["100kHz","100000L"],["400kHz","400000L"]],eepModels:[["24C01",
"T24C01"],["24C02","T24C02"],["24C04","T24C04"],["24C08","T24C08"],["24C16","T24C16"],["24C32","T24C32"],["24C64","T24C64"],["24C128","T24C128"],["24C256","T24C256"],["24C512","T24C512"],["24C1024","T24C1024"],["24C1025","T24C1025"]],builtinLed:[["LED_1","PA_5"]],interrupt:[["interrupt0","2"],["interrupt1","3"]],irqNumber:[["WWDG_IRQn","WWDG_IRQn"],["PVD_IRQn","PVD_IRQn"],["TAMPER_IRQn","TAMPER_IRQn"],["RTC_IRQn","RTC_IRQn"],["FLASH_IRQn","FLASH_IRQn"],["RCC_IRQn","RCC_IRQn"],["EXTI0_IRQn","EXTI0_IRQn"],
["EXTI1_IRQn","EXTI1_IRQn"],["EXTI2_IRQn","EXTI2_IRQn"],["EXTI3_IRQn","EXTI3_IRQn"],["EXTI4_IRQn","EXTI4_IRQn"],["DMA1_Channel1_IRQn","DMA1_Channel1_IRQn"],["DMA1_Channel2_IRQn","DMA1_Channel2_IRQn"],["DMA1_Channel3_IRQn","DMA1_Channel3_IRQn"],["DMA1_Channel4_IRQn","DMA1_Channel4_IRQn"],["DMA1_Channel5_IRQn","DMA1_Channel5_IRQn"],["DMA1_Channel6_IRQn","DMA1_Channel6_IRQn"],["DMA1_Channel7_IRQn","DMA1_Channel7_IRQn"],["ADC1_2_IRQn","ADC1_2_IRQn"],["USB_HP_CAN1_TX_IRQn","USB_HP_CAN1_TX_IRQn"],["USB_LP_CAN1_RX0_IRQn",
"USB_LP_CAN1_RX0_IRQn"],["CAN1_RX1_IRQn","CAN1_RX1_IRQn"],["CAN1_SCE_IRQn","CAN1_SCE_IRQn"],["EXTI9_5_IRQn","EXTI9_5_IRQn"],["TIM1_BRK_IRQn","TIM1_BRK_IRQn"],["TIM1_UP_IRQn","TIM1_UP_IRQn"],["TIM1_TRG_COM_IRQn","TIM1_TRG_COM_IRQn"],["TIM1_CC_IRQn","TIM1_CC_IRQn"],["TIM2_IRQn","TIM2_IRQn"],["TIM3_IRQn","TIM3_IRQn"],["TIM4_IRQn","TIM4_IRQn"],["I2C1_EV_IRQn","I2C1_EV_IRQn"],["I2C1_ER_IRQn","I2C1_ER_IRQn"],["I2C2_EV_IRQn","I2C2_EV_IRQn"],["I2C2_ER_IRQn","I2C2_ER_IRQn"],["SPI1_IRQn","SPI1_IRQn"],["SPI2_IRQn",
"SPI2_IRQn"],["USART1_IRQn","USART1_IRQn"],["USART2_IRQn","USART2_IRQn"],["USART3_IRQn","USART3_IRQn"],["EXTI15_10_IRQn","EXTI15_10_IRQn"],["RTC_Alarm_IRQn","RTC_Alarm_IRQn"],["USBWakeUp_IRQn","USBWakeUp_IRQn"]]};Blockly.mbed.Boards["selected"]=Blockly.mbed.Boards["profiles"]["nucleo_f103rb"];
Blockly.mbed.Boards["refreshBlockFieldDropdown"]=function(block,fieldName,boardKey){var field=block.getField(fieldName);var fieldValue=field.getValue();var dataArray=Blockly.mbed.Boards.selected[boardKey];field.menuGenerator_=dataArray;var currentValuePresent=false;for(var i=0;i<dataArray.length;i++)if(fieldValue==dataArray[i][1])currentValuePresent=true;if(!currentValuePresent)block.setWarningText("The old pin value "+fieldValue+" is no longer available.","bPin");else block.setWarningText(null,"bPin")};Blockly.mbed.colour={};Blockly.mbed["colour_picker"]=Blockly.mbed.noGeneratorCodeInline;Blockly.mbed["colour_random"]=Blockly.mbed.noGeneratorCodeInline;Blockly.mbed["colour_rgb"]=Blockly.mbed.noGeneratorCodeInline;Blockly.mbed["colour_blend"]=Blockly.mbed.noGeneratorCodeInline;Blockly.mbed.filesystem={};Blockly.mbed["sd_fs"]=function(block){var mosi=this.getFieldValue("MOSI");var miso=this.getFieldValue("MISO");var sck=this.getFieldValue("SCK");var cs=this.getFieldValue("CS");var name="sd_"+mosi;Blockly.mbed.addDeclaration(name,"SDFileSystem "+name+"("+mosi+","+miso+","+sck+","+cs+","+'"sd"'+");");Blockly.mbed.addInclude("SDFileSystem",'#include "SDFileSystem.h"');return""};
Blockly.mbed["fs_fopen"]=function(block){var path=Blockly.mbed.valueToCode(block,"PATH",Blockly.mbed.ORDER_NONE);var fp=Blockly.mbed.getVariableName(block,this.getFieldValue("FILE"),Blockly.Variables.NAME_TYPE);var mode=this.getFieldValue("MODE");return fp+" \x3d fopen("+path+', "'+mode+'");\n'};
Blockly.mbed["fs_fscanf"]=function(block){var fp=Blockly.mbed.getVariableName(block,this.getFieldValue("FILE"),Blockly.Variables.NAME_TYPE);var content=Blockly.mbed.valueToCode(block,"CONTENT",Blockly.mbed.ORDER_NONE)||"0";var content_str=Blockly.mbed.valueToCode(block,"CONTENT_STR",Blockly.mbed.ORDER_NONE)||"";var code;if(content_str){content_str=content_str.replace(/\b(\w)/g,"\x26$1");code="fscanf("+fp+","+content+","+content_str+");\n"}else code="fscanf("+fp+","+content+");\n";return code};
Blockly.mbed["fs_fprintf"]=function(block){var fp=Blockly.mbed.getVariableName(block,this.getFieldValue("FILE"),Blockly.Variables.NAME_TYPE);var content=Blockly.mbed.valueToCode(block,"CONTENT",Blockly.mbed.ORDER_NONE)||"0";var content_str=Blockly.mbed.valueToCode(block,"CONTENT_STR",Blockly.mbed.ORDER_NONE)||"";var checkbox_name=block.getFieldValue("NEW_LINE")=="TRUE";if(checkbox_name&&content[content.length-1]==='"')content=content.slice(0,content.length-1)+'\\n"';var code;if(content_str)code="fprintf("+
fp+","+content+","+content_str+");\n";else code="fprintf("+fp+","+content+");\n";return code};Blockly.mbed["fs_fclose"]=function(block){var fp=Blockly.mbed.getVariableName(block,this.getFieldValue("FILE"),Blockly.Variables.NAME_TYPE);return"fclose("+fp+");\n"};Blockly.mbed.IO={};Blockly.mbed["io_digitalwrite"]=function(block){var pin=block.getFieldValue("PIN");var stateOutput=Blockly.mbed.valueToCode(block,"STATE",Blockly.mbed.ORDER_ATOMIC)||"LOW";Blockly.mbed.reservePin(block,pin,Blockly.mbed.PinTypes.OUTPUT,"Digital Write");var digitalOut_Name="myDigitalOut"+pin;Blockly.mbed.addDeclaration(digitalOut_Name,"DigitalOut "+digitalOut_Name+"("+pin+");");var code=digitalOut_Name+".write("+stateOutput+");\n";return code};
Blockly.mbed["io_digitalread"]=function(block){var pin=block.getFieldValue("PIN");Blockly.mbed.reservePin(block,pin,Blockly.mbed.PinTypes.INPUT,"Digital Read");var digitalIn_Name="myDigitalIn"+pin;Blockly.mbed.addDeclaration(digitalIn_Name,"DigitalIn "+digitalIn_Name+"("+pin+");");var code=digitalIn_Name+".read()";return[code,Blockly.mbed.ORDER_ATOMIC]};
Blockly.mbed["io_interrupt"]=function(block){var pin=block.getFieldValue("Pin");var intrName="intr"+pin;var intrType=block.getFieldValue("Type");var pull=block.getFieldValue("Pull");var branch=Blockly.mbed.statementToCode(block,"function_body");if(Blockly.mbed.STATEMENT_PREFIX)branch=Blockly.mbed.prefixLines(Blockly.mbed.STATEMENT_PREFIX.replace(/%1/g,"'"+block.id+"'"),Blockly.mbed.INDENT)+branch;if(Blockly.mbed.INFINITE_LOOP_TRAP)branch=Blockly.mbed.INFINITE_LOOP_TRAP.replace(/%1/g,"'"+block.id+
"'")+branch;var returnValue=Blockly.mbed.valueToCode(block,"RETURN",Blockly.mbed.ORDER_NONE)||"";if(returnValue)returnValue="  return "+returnValue+";\n";var args=[];for(var x=0;x<block.arguments_.length;x++)args[x]=Blockly.mbed.getmbedType_(block.getArgType(block.arguments_[x]))+" "+Blockly.mbed.getVariableName(block,block.arguments_[x],Blockly.Variables.NAME_TYPE);var returnType=Blockly.Types.NULL;if(block.getReturnType)returnType=block.getReturnType();returnType=Blockly.mbed.getmbedType_(returnType);
var functionName=intrName+"_interrupt_fun";var code=returnType+" "+functionName+"("+args.join(", ")+") {\n"+branch+returnValue+"}";Blockly.mbed.userFunctions_[functionName]=code;Blockly.mbed.addDeclaration(intrName,"InterruptIn "+intrName+"("+pin+");");var attach_code=intrName+"."+intrType+"(\x26"+functionName+");\n";attach_code+=intrName+".mode("+pull+");\n";return attach_code};
Blockly.mbed["set_interrupt_prio"]=function(block){var irq=block.getFieldValue("IRQ");var prio=block.getFieldValue("PRIO");var code="NVIC_SetPriority("+irq+", "+prio+");\n";return code};
Blockly.mbed["io_builtin_led"]=function(block){var pin=block.getFieldValue("BUILT_IN_LED");var stateOutput=Blockly.mbed.valueToCode(block,"STATE",Blockly.mbed.ORDER_ATOMIC)||"LOW";Blockly.mbed.reservePin(block,pin,Blockly.mbed.PinTypes.OUTPUT,"Set LED");var digitalOut_Name="myDigitalOut"+pin;Blockly.mbed.addDeclaration(digitalOut_Name,"DigitalOut "+digitalOut_Name+"("+pin+");");var code=digitalOut_Name+".write("+stateOutput+");\n";return code};
Blockly.mbed["io_pwm_set"]=function(block){var pinKey=block.getFieldValue("PWM_PIN");var pwmPeriod=Blockly.mbed.valueToCode(block,"PWM_PERIOD",Blockly.mbed.ORDER_ATOMIC)||"1";var pwmPulseWidth=Blockly.mbed.valueToCode(block,"PWM_WIDTH",Blockly.mbed.ORDER_ATOMIC)||"1";var pwmName="myPwm"+pinKey;var unitPeriod=block.getFieldValue("UNIT_PERIOD");var unitPulseWidth=block.getFieldValue("UNIT_WIDTH");Blockly.mbed.reservePin(block,pinKey,Blockly.mbed.PinTypes.PWM,"PWM Write");Blockly.mbed.addDeclaration("pwm_"+
pinKey,"PwmOut "+pwmName+"("+pinKey+");");var code="";code=code+pwmName+".period_"+unitPeriod+"("+pwmPeriod+");\n";code=code+pwmName+".pulsewidth_"+unitPulseWidth+"("+pwmPulseWidth+");\n";return code};
Blockly.mbed["io_soft_pwm_set"]=function(block){var pinKey=block.getFieldValue("PWM_PIN");var pwmPeriod=Blockly.mbed.valueToCode(block,"PWM_PERIOD",Blockly.mbed.ORDER_ATOMIC)||"1";var pwmPulseWidth=Blockly.mbed.valueToCode(block,"PWM_DUTY",Blockly.mbed.ORDER_ATOMIC)||"1";var pwmName="myPwm"+pinKey;Blockly.mbed.addInclude("IO_pwm",'#include "IO_pwm.h"');Blockly.mbed.addDeclaration(pwmName,"IO_pwm "+pwmName+"("+pinKey+");");var code="";code=code+pwmName+".pwm_io("+pwmPeriod+","+pwmPulseWidth+");\n";
return code};Blockly.mbed["io_analogread"]=function(block){var pin=block.getFieldValue("PIN");Blockly.mbed.reservePin(block,pin,Blockly.mbed.PinTypes.INPUT,"Analogue Read");var ioName="myIO"+pin;Blockly.mbed.addDeclaration("io_"+pin,"AnalogIn "+ioName+"("+pin+");");var code=ioName+".read()";return[code,Blockly.mbed.ORDER_ATOMIC]};Blockly.mbed["io_highlow"]=function(block){var code=block.getFieldValue("STATE");return[code,Blockly.mbed.ORDER_ATOMIC]};
Blockly.mbed["io_pulsein"]=function(block){var pin=block.getFieldValue("PULSEPIN");var type=Blockly.mbed.valueToCode(block,"PULSETYPE",Blockly.mbed.ORDER_ATOMIC);Blockly.mbed.reservePin(block,pin,Blockly.mbed.PinTypes.INPUT,"Pulse Pin");var pinSetupCode="pinMode("+pin+", INPUT);\n";Blockly.mbed.addSetup("io_"+pin,pinSetupCode,false);var code="pulseIn("+pin+", "+type+")";return[code,Blockly.mbed.ORDER_ATOMIC]};
Blockly.mbed["io_pulsetimeout"]=function(block){var pin=block.getFieldValue("PULSEPIN");var type=Blockly.mbed.valueToCode(block,"PULSETYPE",Blockly.mbed.ORDER_ATOMIC);var timeout=Blockly.mbed.valueToCode(block,"TIMEOUT",Blockly.mbed.ORDER_ATOMIC);Blockly.mbed.reservePin(block,pin,Blockly.mbed.PinTypes.INPUT,"Pulse Pin");var pinSetupCode="pinMode("+pin+", INPUT);\n";Blockly.mbed.addSetup("io_"+pin,pinSetupCode,false);var code="pulseIn("+pin+", "+type+", "+timeout+")";return[code,Blockly.mbed.ORDER_ATOMIC]};
Blockly.mbed["pca9685_setpulse"]=function(block){var addr=Blockly.mbed.valueToCode(block,"I2C_ADDR",Blockly.mbed.ORDER_COMMA);var ch=Blockly.mbed.valueToCode(block,"CH",Blockly.mbed.ORDER_COMMA);var period=Blockly.mbed.valueToCode(block,"PWM_PERIOD",Blockly.mbed.ORDER_MULTIPLICATIVE);var duty=Blockly.mbed.valueToCode(block,"PWM_DUTY",Blockly.mbed.ORDER_MULTIPLICATIVE);var code="";code+="pwm.setPWMFreq(1000/"+period+","+addr+");\n";code+="pwm.setPWM("+ch+",0,4095*"+duty+"/"+period+","+addr+");\n";
Blockly.mbed.addSetup("pca_"+addr,"pwm.setPrescale(121,"+addr+");",false);return code};Blockly.mbed["pca9685_setup"]=function(block){var sda=this.getFieldValue("I2C_SDA");var scl=this.getFieldValue("I2C_SCL");var name="pwm";Blockly.mbed.addInclude("PCA9685",'#include "PCA9685.h"');Blockly.mbed.addDeclaration(name,"PCA9685 "+name+"("+sda+","+scl+");");Blockly.mbed.addSetup(name,name+".begin();",false);var code="";return code};Blockly.mbed.lists={};Blockly.mbed["lists_create_empty"]=Blockly.mbed.noGeneratorCodeInline;Blockly.mbed["lists_create_with"]=function(block){return""};Blockly.mbed["lists_repeat"]=Blockly.mbed.noGeneratorCodeInline;Blockly.mbed["lists_length"]=Blockly.mbed.noGeneratorCodeInline;Blockly.mbed["lists_isEmpty"]=Blockly.mbed.noGeneratorCodeInline;Blockly.mbed["lists_indexOf"]=Blockly.mbed.noGeneratorCodeInline;
Blockly.mbed["lists_getIndex"]=function(block){var mode=block.getFieldValue("MODE")||"GET";var where=block.getFieldValue("WHERE")||"FROM_START";var listOrder=where=="RANDOM"?Blockly.mbed.ORDER_COMMA:Blockly.mbed.ORDER_MEMBER;var list=Blockly.mbed.valueToCode(block,"VALUE",listOrder)||"[]";switch(where){case "FIRST":if(mode=="GET"){var code=list+"[0]";return[code,Blockly.mbed.ORDER_MEMBER]}else if(mode=="GET_REMOVE"){var code=list+".shift()";return[code,Blockly.mbed.ORDER_MEMBER]}else if(mode=="REMOVE")return list+
".shift();\n";break;case "LAST":if(mode=="GET"){var code=list+"[sizeof("+list+")/sizeof("+list+"[0])-1]";return[code,Blockly.mbed.ORDER_MEMBER]}else if(mode=="GET_REMOVE"){var code=list+".pop()";return[code,Blockly.mbed.ORDER_MEMBER]}else if(mode=="REMOVE")return list+".pop();\n";break;case "FROM_START":var at=Blockly.mbed.getAdjusted(block,"AT");if(mode=="GET"){var code=list+"["+at+"]";return[code,Blockly.mbed.ORDER_MEMBER]}else if(mode=="GET_REMOVE"){var code=list+".splice("+at+", 1)[0]";return[code,
Blockly.mbed.ORDER_FUNCTION_CALL]}else if(mode=="REMOVE")return list+".splice("+at+", 1);\n";break;case "FROM_END":var at=Blockly.mbed.getAdjusted(block,"AT",1,true);if(mode=="GET"){var code=list+".slice("+at+")[0]";return[code,Blockly.mbed.ORDER_FUNCTION_CALL]}else if(mode=="GET_REMOVE"){var code=list+".splice("+at+", 1)[0]";return[code,Blockly.mbed.ORDER_FUNCTION_CALL]}else if(mode=="REMOVE")return list+".splice("+at+", 1);";break;case "RANDOM":var functionName=Blockly.mbed.provideFunction_("listsGetRandomItem",
["function "+Blockly.mbed.FUNCTION_NAME_PLACEHOLDER_+"(list, remove) {","  var x \x3d Math.floor(Math.random() * list.length);","  if (remove) {","    return list.splice(x, 1)[0];","  } else {","    return list[x];","  }","}"]);code=functionName+"("+list+", "+(mode!="GET")+")";if(mode=="GET"||mode=="GET_REMOVE")return[code,Blockly.mbed.ORDER_FUNCTION_CALL];else if(mode=="REMOVE")return code+";\n";break}throw"Unhandled combination (lists_getIndex).";};
Blockly.mbed["lists_setIndex"]=function(block){var list=Blockly.mbed.valueToCode(block,"LIST",Blockly.mbed.ORDER_MEMBER)||"[]";var mode=block.getFieldValue("MODE")||"GET";var where=block.getFieldValue("WHERE")||"FROM_START";var value=Blockly.mbed.valueToCode(block,"TO",Blockly.mbed.ORDER_ASSIGNMENT)||"null";function cacheList(){if(list.match(/^\w+$/))return"";var listVar=Blockly.mbed.variableDB_.getDistinctName("tmpList",Blockly.Variables.NAME_TYPE);var code="var "+listVar+" \x3d "+list+";\n";list=
listVar;return code}switch(where){case "FIRST":if(mode=="SET")return list+"[0] \x3d "+value+";\n";else if(mode=="INSERT")return list+".unshift("+value+");\n";break;case "LAST":if(mode=="SET"){var code=cacheList();code+=list+"[sizeof("+list+")/sizeof("+list+"[0])-1]"+"\x3d "+value+";\n";return code}else if(mode=="INSERT")return list+".push("+value+");\n";break;case "FROM_START":var at=Blockly.mbed.getAdjusted(block,"AT");if(mode=="SET")return list+"["+at+"] \x3d "+value+";\n";else if(mode=="INSERT")return list+
".splice("+at+", 0, "+value+");\n";break;case "FROM_END":var at=Blockly.mbed.getAdjusted(block,"AT",1,false,Blockly.mbed.ORDER_SUBTRACTION);var code=cacheList();if(mode=="SET"){code+=list+"["+list+".length - "+at+"] \x3d "+value+";\n";return code}else if(mode=="INSERT"){code+=list+".splice("+list+".length - "+at+", 0, "+value+");\n";return code}break;case "RANDOM":var code=cacheList();var xVar=Blockly.mbed.variableDB_.getDistinctName("tmpX",Blockly.Variables.NAME_TYPE);code+="var "+xVar+" \x3d Math.floor(Math.random() * "+
list+".length);\n";if(mode=="SET"){code+=list+"["+xVar+"] \x3d "+value+";\n";return code}else if(mode=="INSERT"){code+=list+".splice("+xVar+", 0, "+value+");\n";return code}break}throw"Unhandled combination (lists_setIndex).";};Blockly.mbed.logic={};
Blockly.mbed["controls_if"]=function(block){var n=0;var argument=Blockly.mbed.valueToCode(block,"IF"+n,Blockly.mbed.ORDER_NONE)||"false";var branch=Blockly.mbed.statementToCode(block,"DO"+n);var code="if ("+argument+") {\n"+branch+"}";for(n=1;n<=block.elseifCount_;n++){argument=Blockly.mbed.valueToCode(block,"IF"+n,Blockly.mbed.ORDER_NONE)||"false";branch=Blockly.mbed.statementToCode(block,"DO"+n);code+=" else if ("+argument+") {\n"+branch+"}"}if(block.elseCount_){branch=Blockly.mbed.statementToCode(block,"ELSE");
code+=" else {\n"+branch+"}"}return code+"\n"};
Blockly.mbed["logic_compare"]=function(block){var OPERATORS={"EQ":"\x3d\x3d","NEQ":"!\x3d","LT":"\x3c","LTE":"\x3c\x3d","GT":"\x3e","GTE":"\x3e\x3d"};var operator=OPERATORS[block.getFieldValue("OP")];var order=operator=="\x3d\x3d"||operator=="!\x3d"?Blockly.mbed.ORDER_EQUALITY:Blockly.mbed.ORDER_RELATIONAL;var argument0=Blockly.mbed.valueToCode(block,"A",order)||"0";var argument1=Blockly.mbed.valueToCode(block,"B",order)||"0";var code=argument0+" "+operator+" "+argument1;return[code,order]};
Blockly.mbed["logic_operation"]=function(block){var operator=block.getFieldValue("OP")=="AND"?"\x26\x26":"||";var order=operator=="\x26\x26"?Blockly.mbed.ORDER_LOGICAL_AND:Blockly.mbed.ORDER_LOGICAL_OR;var argument0=Blockly.mbed.valueToCode(block,"A",order)||"false";var argument1=Blockly.mbed.valueToCode(block,"B",order)||"false";if(!argument0&&!argument1){argument0="false";argument1="false"}else{var defaultArgument=operator=="\x26\x26"?"true":"false";if(!argument0)argument0=defaultArgument;if(!argument1)argument1=
defaultArgument}var code=argument0+" "+operator+" "+argument1;return[code,order]};Blockly.mbed["logic_negate"]=function(block){var order=Blockly.mbed.ORDER_UNARY_PREFIX;var argument0=Blockly.mbed.valueToCode(block,"BOOL",order)||"false";var code="!"+argument0;return[code,order]};Blockly.mbed["logic_boolean"]=function(block){var code=block.getFieldValue("BOOL")=="TRUE"?"true":"false";return[code,Blockly.mbed.ORDER_ATOMIC]};Blockly.mbed["logic_null"]=function(block){var code="NULL";return[code,Blockly.mbed.ORDER_ATOMIC]};
Blockly.mbed["logic_ternary"]=function(block){var valueIf=Blockly.mbed.valueToCode(block,"IF",Blockly.mbed.ORDER_CONDITIONAL)||"false";var valueThen=Blockly.mbed.valueToCode(block,"THEN",Blockly.mbed.ORDER_CONDITIONAL)||"null";var valueElse=Blockly.mbed.valueToCode(block,"ELSE",Blockly.mbed.ORDER_CONDITIONAL)||"null";var code=valueIf+" ? "+valueThen+" : "+valueElse;return[code,Blockly.mbed.ORDER_CONDITIONAL]};Blockly.mbed.loops={};Blockly.mbed["controls_repeat"]=function(block){var repeats=Number(block.getFieldValue("TIMES"));var branch=Blockly.mbed.statementToCode(block,"DO");branch=Blockly.mbed.addLoopTrap(branch,block.id);var loopVar=Blockly.mbed.variableDB_.getDistinctName("count",Blockly.Variables.NAME_TYPE);var code="for (int "+loopVar+" \x3d 0; "+loopVar+" \x3c "+repeats+"; "+loopVar+"++) {\n"+branch+"}\n";return code};
Blockly.mbed["controls_repeat_ext"]=function(block){var repeats=Blockly.mbed.valueToCode(block,"TIMES",Blockly.mbed.ORDER_ADDITIVE)||"0";var branch=Blockly.mbed.statementToCode(block,"DO");branch=Blockly.mbed.addLoopTrap(branch,block.id);var code="";var loopVar=Blockly.mbed.variableDB_.getDistinctName("count",Blockly.Variables.NAME_TYPE);var endVar=repeats;if(!repeats.match(/^\w+$/)&&!Blockly.isNumber(repeats)){var endVar=Blockly.mbed.variableDB_.getDistinctName("repeat_end",Blockly.Variables.NAME_TYPE);
code+="int "+endVar+" \x3d "+repeats+";\n"}code+="for (int "+loopVar+" \x3d 0; "+loopVar+" \x3c "+endVar+"; "+loopVar+"++) {\n"+branch+"}\n";return code};
Blockly.mbed["controls_whileUntil"]=function(block){var until=block.getFieldValue("MODE")=="UNTIL";var argument0=Blockly.mbed.valueToCode(block,"BOOL",until?Blockly.mbed.ORDER_LOGICAL_OR:Blockly.mbed.ORDER_NONE)||"false";var branch=Blockly.mbed.statementToCode(block,"DO");branch=Blockly.mbed.addLoopTrap(branch,block.id);if(until){if(!argument0.match(/^\w+$/))argument0="("+argument0+")";argument0="!"+argument0}return"while ("+argument0+") {\n"+branch+"}\n"};
Blockly.mbed["controls_for"]=function(block){var variable0=Blockly.mbed.getVariableName(block,block.getFieldValue("VAR"),Blockly.Variables.NAME_TYPE);var argument0=Blockly.mbed.valueToCode(block,"FROM",Blockly.mbed.ORDER_ASSIGNMENT)||"0";var argument1=Blockly.mbed.valueToCode(block,"TO",Blockly.mbed.ORDER_ASSIGNMENT)||"0";var increment=Blockly.mbed.valueToCode(block,"BY",Blockly.mbed.ORDER_ASSIGNMENT)||"1";var branch=Blockly.mbed.statementToCode(block,"DO");branch=Blockly.mbed.addLoopTrap(branch,
block.id);var code;if(Blockly.isNumber(argument0)&&Blockly.isNumber(argument1)&&Blockly.isNumber(increment)){var up=parseFloat(argument0)<=parseFloat(argument1);code="for ("+variable0+" \x3d "+argument0+"; "+variable0+(up?" \x3c\x3d ":" \x3e\x3d ")+argument1+"; "+variable0;var step=Math.abs(parseFloat(increment));if(step==1)code+=up?"++":"--";else code+=(up?" +\x3d ":" -\x3d ")+step;code+=") {\n"+branch+"}\n"}else{code="";var startVar=argument0;if(!argument0.match(/^\w+$/)&&!Blockly.isNumber(argument0)){var startVar=
Blockly.mbed.variableDB_.getDistinctName(variable0+"_start",Blockly.Variables.NAME_TYPE);code+="int "+startVar+" \x3d "+argument0+";\n"}var endVar=argument1;if(!argument1.match(/^\w+$/)&&!Blockly.isNumber(argument1)){var endVar=Blockly.mbed.variableDB_.getDistinctName(variable0+"_end",Blockly.Variables.NAME_TYPE);code+="int "+endVar+" \x3d "+argument1+";\n"}var incVar=Blockly.mbed.variableDB_.getDistinctName(variable0+"_inc",Blockly.Variables.NAME_TYPE);code+="int "+incVar+" \x3d ";if(Blockly.isNumber(increment))code+=
Math.abs(increment)+";\n";else code+="abs("+increment+");\n";code+="if ("+startVar+" \x3e "+endVar+") {\n";code+=Blockly.mbed.INDENT+incVar+" \x3d -"+incVar+";\n";code+="}\n";code+="for ("+variable0+" \x3d "+startVar+";\n"+"     "+incVar+" \x3e\x3d 0 ? "+variable0+" \x3c\x3d "+endVar+" : "+variable0+" \x3e\x3d "+endVar+";\n"+"     "+variable0+" +\x3d "+incVar+") {\n"+branch+"}\n"}return code};Blockly.mbed["controls_forEach"]=Blockly.mbed.noGeneratorCodeLine;
Blockly.mbed["controls_flow_statements"]=function(block){switch(block.getFieldValue("FLOW")){case "BREAK":return"break;\n";case "CONTINUE":return"continue;\n"}throw"Unknown flow statement.";};Blockly.mbed.macro={};Blockly.mbed["macro_get"]=function(block){var code=Blockly.mbed.getVariableName(block,block.getFieldValue("MACRO_NAME"),Blockly.Macro.NAME_TYPE);return[code,Blockly.mbed.ORDER_ATOMIC]};
Blockly.mbed["macro_define"]=function(block){var argument0=Blockly.mbed.valueToCode(block,"MACRO_DEFINE_AS",Blockly.mbed.ORDER_ASSIGNMENT)||"0";var varName=Blockly.mbed.getVariableName(block,block.getFieldValue("MACRO_NAME"),Blockly.Macro.NAME_TYPE);Blockly.mbed.addDeclaration(varName,"#define "+varName+" "+argument0);return""};Blockly.mbed.map={};Blockly.mbed["base_map"]=function(block){var valueNum=Blockly.mbed.valueToCode(block,"NUM",Blockly.mbed.ORDER_NONE)||"0";var valueDmax=Blockly.mbed.valueToCode(block,"DMAX",Blockly.mbed.ORDER_ATOMIC)||"0";var code="map("+valueNum+", 0, 1024, 0, "+valueDmax+")";return[code,Blockly.mbed.ORDER_NONE]};Blockly.mbed.math={};Blockly.mbed["math_number"]=function(block){var code=parseFloat(block.getFieldValue("NUM"));if(code==Infinity)code="INFINITY";else if(code==-Infinity)code="-INFINITY";return[code,Blockly.mbed.ORDER_ATOMIC]};
Blockly.mbed["math_arithmetic"]=function(block){var OPERATORS={ADD:[" + ",Blockly.mbed.ORDER_ADDITIVE],MINUS:[" - ",Blockly.mbed.ORDER_ADDITIVE],MULTIPLY:[" * ",Blockly.mbed.ORDER_MULTIPLICATIVE],DIVIDE:[" / ",Blockly.mbed.ORDER_MULTIPLICATIVE],POWER:[null,Blockly.mbed.ORDER_NONE],BITWISE_AND:[" \x26 ",Blockly.mbed.ORDER_BITWISE_AND],BITWISE_OR:[" | ",Blockly.mbed.ORDER_BITWISE_OR]};var tuple=OPERATORS[block.getFieldValue("OP")];var operator=tuple[0];var order=tuple[1];var argument0=Blockly.mbed.valueToCode(block,
"A",order)||"0";var argument1=Blockly.mbed.valueToCode(block,"B",order)||"0";var code;if(!operator){code="Math.pow("+argument0+", "+argument1+")";return[code,Blockly.mbed.ORDER_UNARY_POSTFIX]}code=argument0+operator+argument1;return[code,order]};
Blockly.mbed["math_single"]=function(block){var operator=block.getFieldValue("OP");var code;var arg;if(operator=="NEG"){arg=Blockly.mbed.valueToCode(block,"NUM",Blockly.mbed.ORDER_UNARY_PREFIX)||"0";if(arg[0]=="-")arg=" "+arg;code="-"+arg;return[code,Blockly.mbed.ORDER_UNARY_PREFIX]}if(operator=="ABS"||operator.substring(0,5)=="ROUND")arg=Blockly.mbed.valueToCode(block,"NUM",Blockly.mbed.ORDER_UNARY_POSTFIX)||"0";else if(operator=="SIN"||operator=="COS"||operator=="TAN")arg=Blockly.mbed.valueToCode(block,
"NUM",Blockly.mbed.ORDER_MULTIPLICATIVE)||"0";else arg=Blockly.mbed.valueToCode(block,"NUM",Blockly.mbed.ORDER_NONE)||"0";switch(operator){case "BITWISE_NOT":code="~"+arg;break;case "ABS":code="abs("+arg+")";break;case "ROOT":code="sqrt("+arg+")";break;case "LN":code="log("+arg+")";break;case "EXP":code="exp("+arg+")";break;case "POW10":code="pow(10,"+arg+")";break;case "ROUND":code="round("+arg+")";break;case "ROUNDUP":code="ceil("+arg+")";break;case "ROUNDDOWN":code="floor("+arg+")";break;case "SIN":code=
"sin("+arg+" / 180 * Math.PI)";break;case "COS":code="cos("+arg+" / 180 * Math.PI)";break;case "TAN":code="tan("+arg+" / 180 * Math.PI)";break}if(code)return[code,Blockly.mbed.ORDER_UNARY_POSTFIX];switch(operator){case "LOG10":code="log("+arg+") / log(10)";break;case "ASIN":code="asin("+arg+") / M_PI * 180";break;case "ACOS":code="acos("+arg+") / M_PI * 180";break;case "ATAN":code="atan("+arg+") / M_PI * 180";break;default:throw"Unknown math operator: "+operator;}return[code,Blockly.mbed.ORDER_MULTIPLICATIVE]};
Blockly.mbed["math_constant"]=function(block){var CONSTANTS={"PI":["M_PI",Blockly.mbed.ORDER_UNARY_POSTFIX],"E":["M_E",Blockly.mbed.ORDER_UNARY_POSTFIX],"GOLDEN_RATIO":["(1 + sqrt(5)) / 2",Blockly.mbed.ORDER_MULTIPLICATIVE],"SQRT2":["M_SQRT2",Blockly.mbed.ORDER_UNARY_POSTFIX],"SQRT1_2":["M_SQRT1_2",Blockly.mbed.ORDER_UNARY_POSTFIX],"INFINITY":["INFINITY",Blockly.mbed.ORDER_ATOMIC]};return CONSTANTS[block.getFieldValue("CONSTANT")]};
Blockly.mbed["math_number_property"]=function(block){var number_to_check=Blockly.mbed.valueToCode(block,"NUMBER_TO_CHECK",Blockly.mbed.ORDER_MULTIPLICATIVE)||"0";var dropdown_property=block.getFieldValue("PROPERTY");var code;if(dropdown_property=="PRIME"){var func=["boolean "+Blockly.mbed.DEF_FUNC_NAME+"(int n) {","  // https://en.wikipedia.org/wiki/Primality_test#Naive_methods","  if (n \x3d\x3d 2 || n \x3d\x3d 3) {","    return true;","  }","  // False if n is NaN, negative, is 1.","  // And false if n is divisible by 2 or 3.",
"  if (isnan(n) || (n \x3c\x3d 1) || (n \x3d\x3d 1) || (n % 2 \x3d\x3d 0) || "+"(n % 3 \x3d\x3d 0)) {","    return false;","  }","  // Check all the numbers of form 6k +/- 1, up to sqrt(n).","  for (int x \x3d 6; x \x3c\x3d sqrt(n) + 1; x +\x3d 6) {","    if (n % (x - 1) \x3d\x3d 0 || n % (x + 1) \x3d\x3d 0) {","      return false;","    }","  }","  return true;","}"];var funcName=Blockly.mbed.addFunction("mathIsPrime",func.join("\n"));Blockly.mbed.addInclude("math","#include \x3cmath.h\x3e");code=
funcName+"("+number_to_check+")";return[code,Blockly.mbed.ORDER_UNARY_POSTFIX]}switch(dropdown_property){case "EVEN":code=number_to_check+" % 2 \x3d\x3d 0";break;case "ODD":code=number_to_check+" % 2 \x3d\x3d 1";break;case "WHOLE":Blockly.mbed.addInclude("math","#include \x3cmath.h\x3e");code="(floor("+number_to_check+") \x3d\x3d "+number_to_check+")";break;case "POSITIVE":code=number_to_check+" \x3e 0";break;case "NEGATIVE":code=number_to_check+" \x3c 0";break;case "DIVISIBLE_BY":var divisor=Blockly.mbed.valueToCode(block,
"DIVISOR",Blockly.mbed.ORDER_MULTIPLICATIVE)||"0";code=number_to_check+" % "+divisor+" \x3d\x3d 0";break}return[code,Blockly.mbed.ORDER_EQUALITY]};Blockly.mbed["math_change"]=function(block){var argument0=Blockly.mbed.valueToCode(block,"DELTA",Blockly.mbed.ORDER_ADDITIVE)||"0";var varName=Blockly.mbed.getVariableName(block,block.getFieldValue("VAR"),Blockly.Variables.NAME_TYPE);return varName+" +\x3d "+argument0+";\n"};Blockly.mbed["math_round"]=Blockly.mbed["math_single"];
Blockly.mbed["math_trig"]=Blockly.mbed["math_single"];Blockly.mbed["math_on_list"]=Blockly.mbed.noGeneratorCodeInline;Blockly.mbed["math_modulo"]=function(block){var argument0=Blockly.mbed.valueToCode(block,"DIVIDEND",Blockly.mbed.ORDER_MULTIPLICATIVE)||"0";var argument1=Blockly.mbed.valueToCode(block,"DIVISOR",Blockly.mbed.ORDER_MULTIPLICATIVE)||"0";var code=argument0+" % "+argument1;return[code,Blockly.mbed.ORDER_MULTIPLICATIVE]};
Blockly.mbed["math_constrain"]=function(block){var argument0=Blockly.mbed.valueToCode(block,"VALUE",Blockly.mbed.ORDER_NONE)||"0";var argument1=Blockly.mbed.valueToCode(block,"LOW",Blockly.mbed.ORDER_NONE)||"0";var argument2=Blockly.mbed.valueToCode(block,"HIGH",Blockly.mbed.ORDER_NONE)||"0";var code="("+argument0+" \x3c "+argument1+" ? "+argument1+" : ( "+argument0+" \x3e "+argument2+" ? "+argument2+" : "+argument0+"))";return[code,Blockly.mbed.ORDER_UNARY_POSTFIX]};
Blockly.mbed["math_random_int"]=function(block){var argument0=Blockly.mbed.valueToCode(block,"FROM",Blockly.mbed.ORDER_NONE)||"0";var argument1=Blockly.mbed.valueToCode(block,"TO",Blockly.mbed.ORDER_NONE)||"0";var functionName=Blockly.mbed.variableDB_.getDistinctName("math_random_int",Blockly.Generator.NAME_TYPE);Blockly.mbed.math_random_int.random_function=functionName;var func=["int "+Blockly.mbed.DEF_FUNC_NAME+"(int min, int max) {","  if (min \x3e max) {","    // Swap min and max to ensure min is smaller.",
"    int temp \x3d min;","    min \x3d max;","    max \x3d temp;","  }","  return min + (rand() % (max - min + 1));","}"];var funcName=Blockly.mbed.addFunction("mathRandomInt",func.join("\n"));var code=funcName+"("+argument0+", "+argument1+")";return[code,Blockly.mbed.ORDER_UNARY_POSTFIX]};Blockly.mbed["math_random_float"]=function(block){return["(rand() / RAND_MAX)",Blockly.mbed.ORDER_UNARY_POSTFIX]};Blockly.mbed.parser={};Blockly.mbed["gcode_parse"]=function(block){var line=Blockly.mbed.valueToCode(block,"GCODE",Blockly.mbed.ORDER_NONE)||'""';return"GCode_DoNext("+line+");\n"};Blockly.mbed["gcode_init"]=function(block){return"GCode_Init();\n"};
Blockly.mbed["gcode_cb_home"]=Blockly.mbed["gcode_cb_absmove"]=Blockly.mbed["gcode_cb_setpos"]=function(block){var branch=Blockly.mbed.statementToCode(block,"function_body");if(Blockly.mbed.STATEMENT_PREFIX)branch=Blockly.mbed.prefixLines(Blockly.mbed.STATEMENT_PREFIX.replace(/%1/g,"'"+block.id+"'"),Blockly.mbed.INDENT)+branch;if(Blockly.mbed.INFINITE_LOOP_TRAP)branch=Blockly.mbed.INFINITE_LOOP_TRAP.replace(/%1/g,"'"+block.id+"'")+branch;var returnValue=Blockly.mbed.valueToCode(block,"RETURN",Blockly.mbed.ORDER_NONE)||
"";if(returnValue)returnValue="  return "+returnValue+";\n";var args=[];for(var x=0;x<block.arguments_.length;x++){var name=block.arguments_[x];args[x]=Blockly.mbed.getmbedType_(block.argumentsType_[x]);if(block.argumentsType_[x].typeId===Blockly.Types.ARRAY.typeId)args[x]=args[x].replace(/\[/,name+"[");else args[x]+=" "+name}var returnType=Blockly.Types.NULL;if(block.getReturnType)returnType=block.getReturnType();returnType=Blockly.mbed.getmbedType_(returnType);var functionName=block.callbackName_;
var code=returnType+" "+functionName+"("+args.join(", ")+") {\n"+branch+returnValue+"}";Blockly.mbed.userFunctions_[functionName]=code;return""};Blockly.mbed.procedures={};
Blockly.mbed["procedures_defreturn"]=function(block){var funcName=block.getFieldValue("NAME").replace(/ /g,"_");var branch=Blockly.mbed.statementToCode(block,"STACK");if(Blockly.mbed.STATEMENT_PREFIX)branch=Blockly.mbed.prefixLines(Blockly.mbed.STATEMENT_PREFIX.replace(/%1/g,"'"+block.id+"'"),Blockly.mbed.INDENT)+branch;if(Blockly.mbed.INFINITE_LOOP_TRAP)branch=Blockly.mbed.INFINITE_LOOP_TRAP.replace(/%1/g,"'"+block.id+"'")+branch;var returnValue=Blockly.mbed.valueToCode(block,"RETURN",Blockly.mbed.ORDER_NONE)||
"";if(returnValue)returnValue="  return "+returnValue+";\n";var args=[];for(var x=0;x<block.arguments_.length;x++){var name=block.arguments_[x];args[x]=Blockly.mbed.getmbedType_(block.argumentsType_[x])+" "+name}var returnType=Blockly.Types.NULL;if(block.getReturnType)returnType=block.getReturnType();returnType=Blockly.mbed.getmbedType_(returnType);var code=returnType+" "+funcName+"("+args.join(", ")+") {\n"+branch+returnValue+"}";code=Blockly.mbed.scrub_(block,code);Blockly.mbed.userFunctions_[funcName]=
code;return""};Blockly.mbed["procedures_defnoreturn"]=Blockly.mbed["procedures_defreturn"];Blockly.mbed["procedures_callreturn"]=function(block){var funcName=block.getFieldValue("NAME").replace(/ /g,"_");var args=[];for(var x=0;x<block.arguments_.length;x++)args[x]=Blockly.mbed.valueToCode(block,"ARG"+x,Blockly.mbed.ORDER_NONE)||"null";var code=funcName+"("+args.join(", ")+")";return[code,Blockly.mbed.ORDER_UNARY_POSTFIX]};
Blockly.mbed["procedures_callnoreturn"]=function(block){var funcName=block.getFieldValue("NAME").replace(/ /g,"_");var args=[];for(var x=0;x<block.arguments_.length;x++)args[x]=Blockly.mbed.valueToCode(block,"ARG"+x,Blockly.mbed.ORDER_NONE)||"null";var code=funcName+"("+args.join(", ")+");\n";return code};
Blockly.mbed["procedures_ifreturn"]=function(block){var condition=Blockly.mbed.valueToCode(block,"CONDITION",Blockly.mbed.ORDER_NONE)||"false";var code="if ("+condition+") {\n";if(block.hasReturnValue_){var value=Blockly.mbed.valueToCode(block,"VALUE",Blockly.mbed.ORDER_NONE)||"null";code+="  return "+value+";\n"}else code+="  return;\n";code+="}\n";return code};
Blockly.mbed["mbed_functions"]=function(block){function statementToCodeNoTab(block,name){var targetBlock=block.getInputTargetBlock(name);var code=Blockly.mbed.blockToCode(targetBlock);if(!goog.isString(code))throw'Expecting code from statement block "'+targetBlock.type+'".';return code}var setupBranch=Blockly.mbed.statementToCode(block,"SETUP_FUNC");if(setupBranch)Blockly.mbed.addSetup("userSetupCode",setupBranch,true);var loopBranch=statementToCodeNoTab(block,"LOOP_FUNC");return loopBranch};Blockly.mbed.sensors={};Blockly.mbed["bh1750_read"]=function(block){var name="bh1750_"+block.getFieldValue("I2C_Pins");var code;code=name+".getlightdata()";return[code,Blockly.mbed.ORDER_MEMBER]};
Blockly.mbed["bh1750_setup"]=function(block){var sda=this.getFieldValue("I2C_SDA");var scl=this.getFieldValue("I2C_SCL");var sdaIns=Blockly.mbed.Boards.selected.i2cMapper[sda];var sclIns=Blockly.mbed.Boards.selected.i2cMapper[scl];console.assert(sdaIns==sclIns);var name="bh1750_"+sdaIns;Blockly.mbed.addInclude("sensors",'#include "sensors.h"');Blockly.mbed.addDeclaration(name,"BH1750 "+name+"("+sda+","+scl+");");return""};
Blockly.mbed["bmp180_temp"]=function(block){var name="bmp180_"+block.getFieldValue("I2C_Pins");var code;code=name+".BMP180GetTemperature()";return[code,Blockly.mbed.ORDER_MEMBER]};Blockly.mbed["bmp180_pressure"]=function(block){var name="bmp180_"+block.getFieldValue("I2C_Pins");var code;code=name+".BMP180GetPressure()";return[code,Blockly.mbed.ORDER_MEMBER]};
Blockly.mbed["bmp180_setup"]=function(block){var sda=this.getFieldValue("I2C_SDA");var scl=this.getFieldValue("I2C_SCL");var sdaIns=Blockly.mbed.Boards.selected.i2cMapper[sda];var sclIns=Blockly.mbed.Boards.selected.i2cMapper[scl];console.assert(sdaIns==sclIns);var name="bmp180_"+sdaIns;Blockly.mbed.addInclude("sensors",'#include "sensors.h"');Blockly.mbed.addDeclaration(name,"BMP180 "+name+"("+sda+","+scl+");");return""};
Blockly.mbed["dht11_temp"]=function(block){var name="dht11_"+block.getFieldValue("IO");var code;code=name+".gettemperature()";return[code,Blockly.mbed.ORDER_MEMBER]};Blockly.mbed["dht11_humidity"]=function(block){var name="dht11_"+block.getFieldValue("IO");var code;code=name+".gethumidity()";return[code,Blockly.mbed.ORDER_MEMBER]};Blockly.mbed["dht11_readable"]=function(block){var io=this.getFieldValue("IO");var name="dht11_"+io;var code;code=name+".getdata()";return[code,Blockly.mbed.ORDER_MEMBER]};
Blockly.mbed["dht11_setup"]=function(block){var io=this.getFieldValue("IO");var name="dht11_"+io;Blockly.mbed.addInclude("sensors",'#include "sensors.h"');Blockly.mbed.addDeclaration(name,"dht11 "+name+"("+io+");");return""};Blockly.mbed["ds18B20_temp"]=function(block){var name="ds18B20_"+block.getFieldValue("IO");var code;code=name+".gettemperature()";return[code,Blockly.mbed.ORDER_MEMBER]};
Blockly.mbed["ds18B20_readable"]=function(block){var io=this.getFieldValue("IO");var name="ds18B20_"+io;var code;code=name+".getdata()";return[code,Blockly.mbed.ORDER_MEMBER]};Blockly.mbed["ds18B20_setup"]=function(block){var io=this.getFieldValue("IO");var name="ds18B20_"+io;Blockly.mbed.addInclude("sensors",'#include "sensors.h"');Blockly.mbed.addDeclaration(name,"DS18B20 "+name+"("+io+");");return""};
Blockly.mbed["sr501_o"]=function(block){var name="sr501_"+block.getFieldValue("IO");var code;code=name+".read()";return[code,Blockly.mbed.ORDER_MEMBER]};Blockly.mbed["sr501_readable"]=function(block){var io=this.getFieldValue("IO");var name="sr501_"+io;var code;code=name+"\x3d\x3dtrue";return[code,Blockly.mbed.ORDER_EQUALITY]};Blockly.mbed["sr501_reset"]=function(block){var io=this.getFieldValue("IO");var name="sr501_"+io;var code;code=name+".reset();\n";return code};
Blockly.mbed["sr501_setup"]=function(block){var io=this.getFieldValue("IO");var name="sr501_"+io;Blockly.mbed.addInclude("sensors",'#include "sensors.h"');Blockly.mbed.addDeclaration(name,"sr501 "+name+"("+io+");");return""};
Blockly.mbed["qei_setup"]=function(block){var a=this.getFieldValue("INA");var b=this.getFieldValue("INB");var ppr=this.getFieldValue("PulsesPerRev");var name="qei_"+a;Blockly.mbed.addInclude("QEI",'#include "QEI.h"');Blockly.mbed.addDeclaration(name,"QEI "+name+"("+a+","+b+",NC,"+ppr+",QEI::X4_ENCODING);");return""};Blockly.mbed["qei_get_pulses"]=function(block){var a=this.getFieldValue("INA");var name="qei_"+a;var code;code=name+".getPulses()";return[code,Blockly.mbed.ORDER_MEMBER]};
Blockly.mbed["qei_reset"]=function(block){var a=this.getFieldValue("INA");var name="qei_"+a;var code;code=name+".reset();\n";return code};Blockly.mbed["analog_o"]=function(block){var name="analog_"+block.getFieldValue("IO");var code;code=name+".read()";return[code,Blockly.mbed.ORDER_MEMBER]};Blockly.mbed["analog_readable"]=function(block){var io=this.getFieldValue("IO");var name="analog_"+io;var code;code=name+"\x3d\x3dtrue";return[code,Blockly.mbed.ORDER_EQUALITY]};
Blockly.mbed["analog_reset"]=function(block){var io=this.getFieldValue("IO");var name="analog_"+io;var code;code=name+".reset();\n";return code};Blockly.mbed["analog_setup"]=function(block){var io=this.getFieldValue("IO");var aio=this.getFieldValue("AIO");var name="analog_"+io;Blockly.mbed.addInclude("sensors",'#include "sensors.h"');Blockly.mbed.addDeclaration(name,"YL "+name+"("+io+","+aio+");");return""};
Blockly.mbed["gp2y1010_setup"]=function(block){var led=this.getFieldValue("LED");var mea=this.getFieldValue("Measure");var name="gp2y1010_"+mea;Blockly.mbed.addInclude("sensors",'#include "sensors.h"');Blockly.mbed.addDeclaration(name,"GP2Y1010 "+name+"("+led+","+mea+");");return""};Blockly.mbed["gp2y1010_read"]=function(block){var mea=this.getFieldValue("Measure");var name="gp2y1010_"+mea;var code;code=name+".getairdata()";return[code,Blockly.mbed.ORDER_MEMBER]};
Blockly.mbed["jy901_setup"]=function(block){var tx=this.getFieldValue("TX");var rx=this.getFieldValue("RX");var txIns=Blockly.mbed.Boards.selected.serialMapper[tx];var rxIns=Blockly.mbed.Boards.selected.serialMapper[rx];console.assert(txIns==rxIns);var name="jy901_"+txIns;Blockly.mbed.addInclude("sensors",'#include "sensors.h"');Blockly.mbed.addDeclaration(name,"JY901 "+name+"("+tx+","+rx+");");return""};
Blockly.mbed["jy901_receive"]=function(block){var io=this.getFieldValue("JY901_NAME");var name="jy901_"+io;var code;code=name+".receiveData();\n";return code};
function jy901_get_any(method_name){return function(block){var io=this.getFieldValue("NAME");var arg1=Blockly.mbed.getVariableName(block,this.getFieldValue("ARG1"),Blockly.Variables.NAME_TYPE);var arg2=Blockly.mbed.getVariableName(block,this.getFieldValue("ARG2"),Blockly.Variables.NAME_TYPE);var arg3=Blockly.mbed.getVariableName(block,this.getFieldValue("ARG3"),Blockly.Variables.NAME_TYPE);var name="jy901_"+io;var code;code=name+"."+method_name+"("+arg1+","+arg2+","+arg3+");\n";return code}}
Blockly.mbed["jy901_getacc"]=jy901_get_any("getAcc");Blockly.mbed["jy901_getgyo"]=jy901_get_any("getGyo");Blockly.mbed["jy901_getmag"]=jy901_get_any("getMag");Blockly.mbed["jy901_getatt"]=jy901_get_any("getAttitude");
Blockly.mbed["mpu6050_setup"]=function(block){var sda=this.getFieldValue("I2C_SDA");var scl=this.getFieldValue("I2C_SCL");var txIns=Blockly.mbed.Boards.selected.i2cMapper[sda];var rxIns=Blockly.mbed.Boards.selected.i2cMapper[scl];console.assert(txIns==rxIns);var name="mpu6050_"+txIns;Blockly.mbed.addInclude("MPU6050",'#include "MPU6050.h"');Blockly.mbed.addDeclaration(name,"mpu6050 "+name+"("+sda+","+scl+");");var code=name+".Init();\n";return code};
function mpu6050_get_any(method_name){return function(block){var io=this.getFieldValue("NAME");var arg1=Blockly.mbed.getVariableName(block,this.getFieldValue("ARG1"),Blockly.Variables.NAME_TYPE);var arg2=Blockly.mbed.getVariableName(block,this.getFieldValue("ARG2"),Blockly.Variables.NAME_TYPE);var arg3=Blockly.mbed.getVariableName(block,this.getFieldValue("ARG3"),Blockly.Variables.NAME_TYPE);var name="mpu6050_"+io;var code;code=name+"."+method_name+"(\x26"+arg1+",\x26"+arg2+",\x26"+arg3+");\n";return code}}
Blockly.mbed["mpu6050_getatt"]=mpu6050_get_any("receiveData");Blockly.mbed.serial={};function warp_with_p(content_str){Blockly.mbed.addInclude("converters",'#include "converters.h"');if(!content_str.startsWith("_p("))content_str="_p("+content_str+")";return content_str}
Blockly.mbed["print_content"]=function(block){var format_content=Blockly.mbed.valueToCode(block,"format_content",Blockly.mbed.ORDER_COMMA);var join_content=Blockly.mbed.valueToCode(block,"join_content",Blockly.mbed.ORDER_COMMA)||"";var code;if(join_content)code=warp_with_p(format_content)+","+warp_with_p(join_content);else code=warp_with_p(format_content);return[code,Blockly.mbed.ORDER_ATOMIC]};
Blockly.mbed["serial_print"]=function(block){var serialName=block.getFieldValue("SERIAL_Pins");var content=Blockly.mbed.valueToCode(block,"CONTENT",Blockly.mbed.ORDER_NONE)||"0";var content_str=Blockly.mbed.valueToCode(block,"CONTENT_STR",Blockly.mbed.ORDER_NONE)||"";var checkbox_name=block.getFieldValue("NEW_LINE")=="TRUE";if(checkbox_name&&content[content.length-1]==='"')content=content.slice(0,content.length-1)+'\\n"';var code;if(content_str)code=serialName+".printf("+content+","+warp_with_p(content_str)+
");\n";else code=serialName+".printf("+content+");\n";return code};Blockly.mbed["serial_getc"]=function(block){var serialName=block.getFieldValue("SERIAL_Pins");var code;code=serialName+".getc()";return[code,Blockly.mbed.ORDER_UNARY_POSTFIX]};
Blockly.mbed["serial_setup"]=function(block){var serialId=block.getFieldValue("SERIAL_ID");var serialId_TX=block.getFieldValue("SERIAL_ID_TX");var serialRX=Blockly.mbed.Boards.selected.serialMapper[serialId];var serialTX=Blockly.mbed.Boards.selected.serialMapper[serialId_TX];console.assert(serialRX==serialTX);var serialName=serialRX;var serialSpeed=block.getFieldValue("SPEED");var serialSetupCode=serialName+".baud("+serialSpeed+");";Blockly.mbed.addDeclaration("serial_"+serialId,"Serial "+serialName+
"("+serialId_TX+","+serialId+");");var code=serialSetupCode+"\n";return code};
Blockly.mbed["serial_attach"]=function(block){var serialName=block.getFieldValue("SERIAL_Pins");var branch=Blockly.mbed.statementToCode(block,"function_body");if(Blockly.mbed.STATEMENT_PREFIX)branch=Blockly.mbed.prefixLines(Blockly.mbed.STATEMENT_PREFIX.replace(/%1/g,"'"+block.id+"'"),Blockly.mbed.INDENT)+branch;if(Blockly.mbed.INFINITE_LOOP_TRAP)branch=Blockly.mbed.INFINITE_LOOP_TRAP.replace(/%1/g,"'"+block.id+"'")+branch;var returnValue=Blockly.mbed.valueToCode(block,"RETURN",Blockly.mbed.ORDER_NONE)||
"";if(returnValue)returnValue="  return "+returnValue+";\n";var args=[];for(var x=0;x<block.arguments_.length;x++)args[x]=Blockly.mbed.getmbedType_(block.getArgType(block.arguments_[x]))+" "+Blockly.mbed.getVariableName(block,block.arguments_[x],Blockly.Variables.NAME_TYPE);var returnType=Blockly.Types.NULL;if(block.getReturnType)returnType=block.getReturnType();returnType=Blockly.mbed.getmbedType_(returnType);var functionName=serialName+"_interrupt_fun";var code=returnType+" "+functionName+"("+args.join(", ")+
") {\n"+branch+returnValue+"}";Blockly.mbed.userFunctions_[functionName]=code;var attach_code=serialName+".attach(\x26"+functionName+");\n";return attach_code};
Blockly.mbed["syn6288_setup"]=function(block){var serialId=block.getFieldValue("SERIAL_ID");var serialId_TX=block.getFieldValue("SERIAL_ID_TX");var serialRX=Blockly.mbed.Boards.selected.serialMapper[serialId];var serialTX=Blockly.mbed.Boards.selected.serialMapper[serialId_TX];console.assert(serialRX==serialTX);var hsuName="syn6288_"+serialRX;Blockly.mbed.addDeclaration(hsuName,"Serial "+hsuName+"("+serialId_TX+","+serialId+");");Blockly.mbed.addInclude("SYN6288",'#include "SYN6288.h"');var code="";
return code};Blockly.mbed["syn6288_speak"]=function(block){var serialId=block.getFieldValue("SERIAL_ID");var textArg=Blockly.mbed.valueToCode(block,"TEXT",Blockly.mbed.ORDER_COMMA)||'""';var hsuName="syn6288_"+serialId;var code="voice_play("+textArg+",\x26"+hsuName+");\n";return code};
Blockly.mbed["pn532_setup"]=function(block){var serialId=block.getFieldValue("SERIAL_ID");var serialId_TX=block.getFieldValue("SERIAL_ID_TX");var serialRX=Blockly.mbed.Boards.selected.serialMapper[serialId];var serialTX=Blockly.mbed.Boards.selected.serialMapper[serialId_TX];console.assert(serialRX==serialTX);var hsuName="pn_hsu_"+serialRX;var pn532Name="pn532_"+serialRX;var serialSpeed="115200";Blockly.mbed.addDeclaration(hsuName,"HardwareSerial "+hsuName+"("+serialId_TX+","+serialId+");");Blockly.mbed.addDeclaration(pn532Name,
"PN532Checker "+pn532Name+"(\x26"+hsuName+");");Blockly.mbed.addInclude("PN532Checker",'#include "pn532_cardcheck.h"');var serialSetupCode=hsuName+".baud("+serialSpeed+");\n";var pnSetupCode=pn532Name+".setup();\n";var code=serialSetupCode+pnSetupCode;return code};
Blockly.mbed["pn532_wait_card"]=function(block){var serialId=block.getFieldValue("SERIAL_Pins");var timeo=block.getFieldValue("TIMEOUT")||"100";var pn532Name="pn532_"+serialId;var code;code=pn532Name+".start_check("+timeo+")";return[code,Blockly.mbed.ORDER_UNARY_POSTFIX]};Blockly.mbed["pn532_read_user"]=function(block){var serialId=block.getFieldValue("SERIAL_Pins");var pn532Name="pn532_"+serialId;var code;code=pn532Name+".get_userid()";return[code,Blockly.mbed.ORDER_UNARY_POSTFIX]};
Blockly.mbed["pn532_read_passwd"]=function(block){var serialId=block.getFieldValue("SERIAL_Pins");var pn532Name="pn532_"+serialId;var code;code=pn532Name+".get_passwd()";return[code,Blockly.mbed.ORDER_UNARY_POSTFIX]};function esp8266_build_sensors_actuators(arr){return arr.map(function(item){item=item.trim();if(item)return'{"'+item+'",""},';else return""}).filter(function(item){return item.length>0}).join("")}
Blockly.mbed["esp8266_setup"]=function(block){var host=this.getFieldValue("host");var ssid=this.getFieldValue("ssid");var passwd=this.getFieldValue("passwd");var node=this.getFieldValue("node");var TX=this.getFieldValue("TX");var RX=this.getFieldValue("RX");var sensors=esp8266_build_sensors_actuators(this.getFieldValue("sensors").split(","));var actuators=esp8266_build_sensors_actuators(this.getFieldValue("actuators").split(","));Blockly.mbed.addInclude("esp8266",'#include "esp8266.h"');var code=
"";code+="Esp8266 Esp8266client_("+TX+", "+RX+', "'+ssid+'", "'+passwd+'");\n';code+="const char* esp8266sensors_[][2] \x3d {"+sensors+"{NULL,NULL}};\n";code+="const char* esp8266actuators_[][2] \x3d {"+actuators+"{NULL,NULL}};\n";code+='Esp8266client_.connect_mqtt_broker("'+host+'", "'+node+'", esp8266sensors_, esp8266actuators_);\n';return code};
Blockly.mbed["esp8266_publish"]=function(block){var topic=Blockly.mbed.valueToCode(block,"topic",Blockly.mbed.ORDER_COMMA)||'""';var value=Blockly.mbed.valueToCode(block,"value",Blockly.mbed.ORDER_COMMA)||'""';return"Esp8266client_.publish_value("+topic+", "+value+");\n"};
Blockly.mbed["esp8266_receive"]=function(block){var topic=Blockly.mbed.getVariableName(block,this.getFieldValue("topic"),Blockly.Variables.NAME_TYPE);var value=Blockly.mbed.getVariableName(block,this.getFieldValue("value"),Blockly.Variables.NAME_TYPE);var code;code="Esp8266client_.get_control_cmd("+topic+", "+value+")";return[code,Blockly.mbed.ORDER_MEMBER]};
Blockly.mbed["hxd019_setup"]=function(block){var HXDsda=this.getFieldValue("HXD_SDA");var HXDscl=this.getFieldValue("HXD_SCL");var HXDBusy=this.getFieldValue("HXD_BUSY");var eepName="eeprom";Blockly.mbed.addInclude("hxd019",'#include "ir.h"');var code="IR_Init("+HXDscl+","+HXDsda+","+HXDBusy+","+eepName+");\n";return code};Blockly.mbed["hxd019_learn"]=function(block){var ch=Blockly.mbed.valueToCode(block,"CH",Blockly.mbed.ORDER_ATOMIC)||1;var code;code="IR_StartLearning("+ch+");\n";return code};
Blockly.mbed["hxd019_emit"]=function(block){var ch=Blockly.mbed.valueToCode(block,"CH",Blockly.mbed.ORDER_ATOMIC)||1;var code;code="IR_Emit("+ch+");\n";return code};
Blockly.mbed["i2c_eep_setup"]=function(block){var EEPsda=this.getFieldValue("EEP_SDA");var EEPscl=this.getFieldValue("EEP_SCL");var EEPtype=this.getFieldValue("EEP_TYPE");var eepName="eeprom";Blockly.mbed.addDeclaration(eepName,"EEPROM "+eepName+"("+EEPsda+","+EEPscl+",0,EEPROM::"+EEPtype+");");Blockly.mbed.addInclude("eeprom",'#include "eeprom.h"');return""};
Blockly.mbed["i2c_eep_read"]=function(block){var Length=Blockly.mbed.valueToCode(block,"Length",Blockly.mbed.ORDER_COMMA)||1;var Addr=Blockly.mbed.valueToCode(block,"Addr",Blockly.mbed.ORDER_COMMA)||0;var eepName="eeprom";return["simple_eeprom_read("+eepName+","+Addr+","+Length+")",Blockly.mbed.ORDER_UNARY_POSTFIX]};
Blockly.mbed["i2c_eep_write"]=function(block){var Data=Blockly.mbed.valueToCode(block,"Data",Blockly.mbed.ORDER_COMMA)||1;var Addr=Blockly.mbed.valueToCode(block,"Addr",Blockly.mbed.ORDER_COMMA)||0;var eepName="eeprom";var code="simple_eeprom_write("+eepName+","+Addr+","+Data+");\n";return code};Blockly.mbed.servo={};
Blockly.mbed["servo_write"]=function(block){var pinKey=block.getFieldValue("SERVO_PIN");var servoPulseWidth=Blockly.mbed.valueToCode(block,"SERVO_PULSEWIDTH",Blockly.mbed.ORDER_ATOMIC)||"1";var servoName="myServo"+pinKey;var timeDomain=block.getFieldValue("TimeDomain");Blockly.mbed.reservePin(block,pinKey,Blockly.mbed.PinTypes.SERVO,"Servo Write");Blockly.mbed.addDeclaration("servo_"+pinKey,"PwmOut "+servoName+"("+pinKey+");");var code=servoName+".period_ms(20);\n";code=code+servoName+".pulsewidth_"+
timeDomain+"("+servoPulseWidth+");\n";return code};
Blockly.mbed["servo_read"]=function(block){var pinKey=block.getFieldValue("SERVO_PIN");var servoName="myServo"+pinKey;Blockly.mbed.reservePin(block,pinKey,Blockly.mbed.PinTypes.SERVO,"Servo Read");Blockly.mbed.addInclude("servo","#include \x3cServo.h\x3e");Blockly.mbed.addDeclaration("servo_"+pinKey,"Servo "+servoName+";");var setupCode=servoName+".attach("+pinKey+");";Blockly.mbed.addSetup("servo_"+pinKey,setupCode,true);var code=servoName+".read()";return[code,Blockly.mbed.ORDER_ATOMIC]};
Blockly.mbed["stepper_setup"]=function(block){var stepPin=block.getFieldValue("STEP_Pin");var dirPin=block.getFieldValue("DIR_Pin");var enPin=block.getFieldValue("EN_Pin");Blockly.mbed.reservePin(block,stepPin,Blockly.mbed.PinTypes.STEPPER,"Stepper STEP");Blockly.mbed.reservePin(block,dirPin,Blockly.mbed.PinTypes.STEPPER,"Stepper DIR");Blockly.mbed.reservePin(block,enPin,Blockly.mbed.PinTypes.STEPPER,"Stepper EN");Blockly.mbed.addInclude("Stepper","#include \x3cstepper.h\x3e");Blockly.mbed.addDeclaration("stepper"+
stepPin,"Stepper stepper"+stepPin+" \x3d {"+stepPin+","+dirPin+","+enPin+"};");return""};Blockly.mbed["stepper_rotate"]=function(block){var stepPin=block.getFieldValue("STEP_Pin");var period=Blockly.mbed.valueToCode(block,"PERIOD",Blockly.mbed.ORDER_ATOMIC)||"1";var steps=Blockly.mbed.valueToCode(block,"STEP",Blockly.mbed.ORDER_ATOMIC)||"1";var unitPeriod=block.getFieldValue("UNIT_PERIOD")==="us"?"_us":"";var code="stepper"+stepPin;code=code+".rotate"+unitPeriod+"("+period+", "+steps+");\n";return code};
Blockly.mbed["stepper_wait"]=function(block){var stepPin=block.getFieldValue("STEP_Pin");var code="while(stepper"+stepPin+".remain);\n";return code};Blockly.mbed.spi={};
Blockly.mbed["spi_setup"]=function(block){var spiId=block.getFieldValue("SPI_ID");var spiFrequency=Blockly.mbed.valueToCode(block,"frequency",Blockly.mbed.ORDER_ATOMIC)||1;var spiMode=block.getFieldValue("SPI_MODE");var cs=block.getFieldValue("PIN");var spi_pins=[];if(spiId=="SPI1"&&block.getFieldValue("SPI1_ID")=="PB_3,PB_4,PB_5")spi_pins=Blockly.mbed.Boards.selected.spi1_alternative;else spi_pins=Blockly.mbed.Boards.selected.spiPins[spiId];var spiName="spi_"+spiId;var digitalOut_Name="myDigitalOut"+
cs;Blockly.mbed.addDeclaration(spiName,"SPI "+spiName+"("+spi_pins["MOSI"]+","+spi_pins["MISO"]+","+spi_pins["SCK"]+");");Blockly.mbed.addDeclaration(digitalOut_Name,"DigitalOut "+digitalOut_Name+"("+cs+");");var code="";code+=spiName+".frequency("+spiFrequency*1E5+");\n";code+=spiName+".format(8,"+spiMode+");\n";code+=digitalOut_Name+".write(0);\n";return code};
Blockly.mbed["spi_transfer"]=function(block){var spiId=block.getFieldValue("SPI_ID");var spiData=Blockly.mbed.valueToCode(block,"SPI_DATA",Blockly.mbed.ORDER_ATOMIC)||"0";var spiName="spi_"+spiId;var code=spiName+".write("+spiData+");\n";return code};
Blockly.mbed["spi_transfer_return"]=function(block){var spiId=block.getFieldValue("SPI_ID");var spiSs=block.getFieldValue("SPI_SS");var spiData=Blockly.mbed.valueToCode(block,"SPI_DATA",Blockly.mbed.ORDER_ATOMIC)||"0";var spiTransferOnlyCode=Blockly.mbed["spi_transfer"](block);if(spiSs==="none")var code=spiId+".transfer("+spiData+")";else{var func=["int "+Blockly.mbed.DEF_FUNC_NAME+"() {","  int spiReturn \x3d 0;","  digitalWrite("+spiSs+", HIGH);","  spiReturn \x3d "+spiId+".transfer("+spiData+");",
"  digitalWrite("+spiSs+", LOW);","  return spiReturn;","}"];var functionName=Blockly.mbed.addFunction("spiReturnSlave"+spiSs,func.join("\n"));var code=functionName+"()"}return[code,Blockly.mbed.ORDER_UNARY_POSTFIX]};
Blockly.mbed["nrf24_setup"]=function(block){var mosi=this.getFieldValue("MOSI");var miso=this.getFieldValue("MISO");var sck=this.getFieldValue("SCK");var cs=this.getFieldValue("CS");var ce=this.getFieldValue("CE");var irq=this.getFieldValue("IRQ");var size=this.getFieldValue("SIZE");var ch=this.getFieldValue("CH");var name="nrf24_"+mosi;var macroSize="NRF24_TRANSFER_SIZE";Blockly.mbed.addDeclaration(macroSize,"#define "+macroSize+" "+size);Blockly.mbed.addDeclaration(name,"nRF24L01P "+name+"("+mosi+
","+miso+","+sck+","+cs+","+ce+","+irq+");");Blockly.mbed.addInclude("nRF24L01P",'#include "nRF24L01P.h"');return name+".powerUp();\n"+name+".setTransferSize( "+macroSize+" );\n"+name+".setReceiveMode();\n"+name+".setRxAddress("+ch+"ull);\n"+name+".setTxAddress("+ch+"ull);\n"+name+".enable();\n"};Blockly.mbed["nrf24_check_irq"]=function(block){var mosi=this.getFieldValue("MOSI");var name="nrf24_"+mosi;var code;code=name+".NRF24L01_IRQ();\n";return code};
Blockly.mbed["nrf24_readable"]=function(block){var mosi=this.getFieldValue("MOSI");var name="nrf24_"+mosi;var code;code=name+".readable()";return[code,Blockly.mbed.ORDER_MEMBER]};Blockly.mbed["nrf24_checksum"]=function(block){var buf=Blockly.mbed.getVariableName(block,this.getFieldValue("BUF"),Blockly.Variables.NAME_TYPE);var mosi=this.getFieldValue("MOSI");var name="nrf24_"+mosi;var code;code=name+".Get_Checksum("+buf+")";return[code,Blockly.mbed.ORDER_MEMBER]};
Blockly.mbed["nrf24_read"]=function(block){var buf=Blockly.mbed.getVariableName(block,this.getFieldValue("BUF"),Blockly.Variables.NAME_TYPE);var mosi=this.getFieldValue("MOSI");var name="nrf24_"+mosi;var code;code=name+".read( NRF24L01P_PIPE_P0, "+buf+", NRF24_TRANSFER_SIZE);\n";return code};
Blockly.mbed["nrf24_write"]=function(block){var buf=Blockly.mbed.getVariableName(block,this.getFieldValue("BUF"),Blockly.Variables.NAME_TYPE);var mosi=this.getFieldValue("MOSI");var name="nrf24_"+mosi;var code;code=name+".write( NRF24L01P_PIPE_P0, "+buf+", NRF24_TRANSFER_SIZE);\n";return code};
Blockly.mbed["nrf24_write_len"]=function(block){var buf=Blockly.mbed.getVariableName(block,this.getFieldValue("BUF"),Blockly.Variables.NAME_TYPE);var len=Blockly.mbed.getVariableName(block,this.getFieldValue("LEN"),Blockly.Variables.NAME_TYPE);var mosi=this.getFieldValue("MOSI");var name="nrf24_"+mosi;var code;code=name+".NRF_Send_TX("+buf+","+len+");\n";return code};
function w5500_build_sensors_actuators(arr){return arr.map(function(item){item=item.trim();if(item)return'{"'+item+'",""},';else return""}).filter(function(item){return item.length>0}).join("")}
Blockly.mbed["w5500_setup"]=function(block){var mosi=this.getFieldValue("MOSI");var miso=this.getFieldValue("MISO");var sck=this.getFieldValue("SCK");var cs=this.getFieldValue("CS");var reset=this.getFieldValue("RESET");var host=this.getFieldValue("host").trim();var node=this.getFieldValue("node").trim();var mqttUser=this.getFieldValue("mqttUser");var mqttPasswd=this.getFieldValue("mqttPasswd");var sensors=w5500_build_sensors_actuators(this.getFieldValue("sensors").split(","));var actuators=w5500_build_sensors_actuators(this.getFieldValue("actuators").split(","));
Blockly.mbed.addInclude("w5500",'#include "networking.h"');Blockly.mbed.addDeclaration("w5500_wiz","WIZnetInterface "+"w5500_wiz"+"("+mosi+","+miso+","+sck+","+cs+","+reset+");");var code="";code+="MQTTSocket w5500sock_;\n";code+="MClient w5500client_(w5500sock_);\n";code+="const char* w5500sensors_[][2] \x3d {"+sensors+"{NULL,NULL}};\n";code+="const char* w5500actuators_[][2] \x3d {"+actuators+"{NULL,NULL}};\n";code+='networking_init(w5500_wiz, w5500sock_, w5500client_, "'+host+'","'+node+'", w5500sensors_, w5500actuators_, W5500_on_command, '+
(mqttUser.length?'"'+mqttUser+'", ':"NULL, ")+(mqttPasswd.length?'"'+mqttPasswd+'" ':"NULL ")+");\n";return code};Blockly.mbed["w5500_yield"]=function(block){var t=this.getFieldValue("timeout");var code;code="w5500client_.yield("+t+");\n";return code};
Blockly.mbed["w5500_publish"]=function(block){var topic=Blockly.mbed.valueToCode(block,"topic",Blockly.mbed.ORDER_COMMA)||'""';var value=Blockly.mbed.valueToCode(block,"value",Blockly.mbed.ORDER_COMMA)||'""';return"publish_value(w5500client_, "+topic+", "+value+");\n"};
Blockly.mbed["w5500_command"]=function(block){var branch=Blockly.mbed.statementToCode(block,"function_body");if(Blockly.mbed.STATEMENT_PREFIX)branch=Blockly.mbed.prefixLines(Blockly.mbed.STATEMENT_PREFIX.replace(/%1/g,"'"+block.id+"'"),Blockly.mbed.INDENT)+branch;if(Blockly.mbed.INFINITE_LOOP_TRAP)branch=Blockly.mbed.INFINITE_LOOP_TRAP.replace(/%1/g,"'"+block.id+"'")+branch;var returnValue=Blockly.mbed.valueToCode(block,"RETURN",Blockly.mbed.ORDER_NONE)||"";if(returnValue)returnValue="  return "+
returnValue+";\n";var args=[];for(var x=0;x<block.arguments_.length;x++){var name=block.arguments_[x];args[x]=Blockly.mbed.getmbedType_(block.argumentsType_[x]);if(block.argumentsType_[x].typeId===Blockly.Types.ARRAY.typeId)args[x]=args[x].replace(/\[/,name+"[");else args[x]+=" "+name}var returnType=Blockly.Types.NULL;if(block.getReturnType)returnType=block.getReturnType();returnType=Blockly.mbed.getmbedType_(returnType);var functionName=block.callbackName_;var code=returnType+" "+functionName+"("+
args.join(", ")+") {\n"+branch+returnValue+"}";Blockly.mbed.userFunctions_[functionName]=code;return""};
Blockly.mbed["ld3320_setup"]=function(block){var mosi=this.getFieldValue("MOSI");var miso=this.getFieldValue("MISO");var sck=this.getFieldValue("SCK");var cs=this.getFieldValue("CS");var reset=this.getFieldValue("RESET");Blockly.mbed.addInclude("ld3320",'#include "ld3320.h"');Blockly.mbed.addDeclaration("ld3320_inst","VoiceRecognition "+"ld3320_inst"+"("+cs+","+miso+","+mosi+","+sck+","+reset+");");var code="ld3320_inst.init();\n";return code};
Blockly.mbed["ld3320_start"]=function(block){var code="ld3320_inst.start();\n";return code};Blockly.mbed["ld3320_add"]=function(block){var words=this.getFieldValue("words");var id=this.getFieldValue("id");var code='ld3320_inst.addCommand("'+words+'", '+id+");\n";return code};Blockly.mbed["ld3320_read"]=function(block){var name="ld3320_inst";var code;code=name+".read()";return[code,Blockly.mbed.ORDER_MEMBER]};Blockly.mbed.text={};Blockly.mbed["text"]=function(block){var code=Blockly.mbed.quote_(block.getFieldValue("TEXT"));return[code,Blockly.mbed.ORDER_ATOMIC]};
Blockly.mbed["text_join"]=function(block){var code;if(block.itemCount_==0)return['""',Blockly.mbed.ORDER_ATOMIC];else if(block.itemCount_==1){var argument0=Blockly.mbed.valueToCode(block,"ADD0",Blockly.mbed.ORDER_UNARY_POSTFIX)||'""';code="String("+argument0+")";return[code,Blockly.mbed.ORDER_UNARY_POSTFIX]}else{var argument;code=[];for(var n=0;n<block.itemCount_;n++){argument=Blockly.mbed.valueToCode(block,"ADD"+n,Blockly.mbed.ORDER_NONE);if(argument=="")code[n]='""';else code[n]="String("+argument+
")"}code=code.join(" + ");return[code,Blockly.mbed.ORDER_UNARY_POSTFIX]}};Blockly.mbed["text_append"]=function(block){var varName=Blockly.mbed.getVariableName(block,block.getFieldValue("VAR"),Blockly.Variables.NAME_TYPE);var argument0=Blockly.mbed.valueToCode(block,"TEXT",Blockly.mbed.ORDER_UNARY_POSTFIX);if(argument0=="")argument0='""';else argument0="String("+argument0+")";return varName+" +\x3d "+argument0+";\n"};
Blockly.mbed["text_length"]=function(block){var argument0=Blockly.mbed.valueToCode(block,"VALUE",Blockly.mbed.ORDER_UNARY_POSTFIX)||'""';var code="String("+argument0+").length()";return[code,Blockly.mbed.ORDER_UNARY_POSTFIX]};
Blockly.mbed["text_isEmpty"]=function(block){var func=[];func.push("boolean "+Blockly.mbed.DEF_FUNC_NAME+"(String msg) {");func.push("  if (msg.length() \x3d\x3d 0) {");func.push("    return true;");func.push("  } else {");func.push("    return false;");func.push("  }");func.push("}");var funcName=Blockly.mbed.addFunction("isStringEmpty",func.join("\n"));var argument0=Blockly.mbed.valueToCode(block,"VALUE",Blockly.mbed.ORDER_UNARY_POSTFIX);if(argument0=="")argument0='""';else argument0="String("+
argument0+")";var code=funcName+"("+argument0+")";return[code,Blockly.mbed.ORDER_UNARY_POSTFIX]};Blockly.mbed["text_trim"]=function(block){Blockly.mbed.text_trim.OPERATORS={LEFT:".trim()",RIGHT:".trim()",BOTH:".trim()"};var mode=block.getFieldValue("MODE");var operator=Blockly.mbed.text_trim.OPERATORS[mode];var argument0=Blockly.mbed.valueToCode(block,"TEXT",Blockly.mbed.ORDER_UNARY_POSTFIX);if(argument0=="")argument0='""';else argument0="String("+argument0+")";return[argument0+operator,Blockly.mbed.ORDER_UNARY_POSTFIX]};
Blockly.mbed["text_print"]=function(block){var serialId=Blockly.mbed.Boards.selected.serial[0][1];var setupCode=serialId+".begin(9600);";Blockly.mbed.addSetup("serial_"+serialId,setupCode,false);var argument0=Blockly.mbed.valueToCode(block,"TEXT",Blockly.mbed.ORDER_NONE);if(argument0=="")argument0='""';else argument0="String("+argument0+")";return serialId+".print("+argument0+");\n"};
Blockly.mbed["text_prompt_ext"]=function(block){var serialId=Blockly.mbed.Boards.selected.serial[0][1];var returnType=block.getFieldValue("TYPE");var func=[];var toNumber=returnType==Blockly.Types.NUMBER.output;if(toNumber)func.push("int "+Blockly.mbed.DEF_FUNC_NAME+"(String msg) {");else func.push("String "+Blockly.mbed.DEF_FUNC_NAME+"(String msg) {");func.push("  "+serialId+".println(msg);");func.push("  boolean stringComplete \x3d false;");if(toNumber)func.push("  int content \x3d 0;");else func.push('  String content \x3d "";');
func.push("  while (stringComplete \x3d\x3d false) {");func.push("    if ("+serialId+".available()) {");if(toNumber){func.push("      content \x3d "+serialId+".parseInt();");func.push("      stringComplete \x3d true;")}else{func.push("      char readChar \x3d (char)"+serialId+".read();");func.push("      if (readChar \x3d\x3d '\\n' || readChar \x3d\x3d '\\r') {");func.push("        stringComplete \x3d true;");func.push("      } else {");func.push("        content +\x3d readChar;");func.push("      }")}func.push("    }");
func.push("  }");func.push("  // Empty incoming serial buffer");func.push("  while(Serial.available()) { Serial.read(); };");func.push("  return content;");func.push("}");var funcName=Blockly.mbed.addFunction("getUserInputPrompt"+returnType,func.join("\n"));var setupCode=serialId+".begin(9600);";Blockly.mbed.addSetup("serial_"+serialId,setupCode,false);var msg=Blockly.mbed.valueToCode(block,"TEXT",Blockly.mbed.ORDER_NONE)||'""';var code=funcName+"("+msg+")";return[code,Blockly.mbed.ORDER_UNARY_POSTFIX]};
Blockly.mbed["text_endString"]=function(block){return["",Blockly.mbed.ORDER_UNARY_POSTFIX]};Blockly.mbed["text_indexOf"]=function(block){return["",Blockly.mbed.ORDER_UNARY_POSTFIX]};Blockly.mbed["text_charAt"]=function(block){return["",Blockly.mbed.ORDER_UNARY_POSTFIX]};Blockly.mbed["text_getSubstring"]=function(block){return["",Blockly.mbed.ORDER_UNARY_POSTFIX]};Blockly.mbed["text_changeCase"]=function(block){return["",Blockly.mbed.ORDER_UNARY_POSTFIX]};
Blockly.mbed["text_prompt"]=function(block){return["",Blockly.mbed.ORDER_UNARY_POSTFIX]};Blockly.mbed.time={};Blockly.mbed["time_delay"]=function(block){var delayTime=Blockly.mbed.valueToCode(block,"DELAY_TIME_MILI",Blockly.mbed.ORDER_ATOMIC)||"0";var code="wait_ms("+delayTime+");\n";return code};Blockly.mbed["time_delaymicros"]=function(block){var delayTimeMs=Blockly.mbed.valueToCode(block,"DELAY_TIME_MICRO",Blockly.mbed.ORDER_ATOMIC)||"0";var code="wait_us("+delayTimeMs+");\n";return code};Blockly.mbed["time_millis"]=function(block){var code="millis()";return[code,Blockly.mbed.ORDER_ATOMIC]};
Blockly.mbed["time_micros"]=function(block){var code="micros()";return[code,Blockly.mbed.ORDER_ATOMIC]};Blockly.mbed["infinite_loop"]=function(block){return"while(true);\n"};
Blockly.mbed["ticker_attach"]=function(block){var ticks=block.getFieldValue("ticks");var tickName="tick"+String(Math.random()).substring(2,8);var branch=Blockly.mbed.statementToCode(block,"function_body");if(Blockly.mbed.STATEMENT_PREFIX)branch=Blockly.mbed.prefixLines(Blockly.mbed.STATEMENT_PREFIX.replace(/%1/g,"'"+block.id+"'"),Blockly.mbed.INDENT)+branch;if(Blockly.mbed.INFINITE_LOOP_TRAP)branch=Blockly.mbed.INFINITE_LOOP_TRAP.replace(/%1/g,"'"+block.id+"'")+branch;var returnValue=Blockly.mbed.valueToCode(block,
"RETURN",Blockly.mbed.ORDER_NONE)||"";if(returnValue)returnValue="  return "+returnValue+";\n";var args=[];for(var x=0;x<block.arguments_.length;x++)args[x]=Blockly.mbed.getmbedType_(block.getArgType(block.arguments_[x]))+" "+Blockly.mbed.getVariableName(block,block.arguments_[x],Blockly.Variables.NAME_TYPE);var returnType=Blockly.Types.NULL;if(block.getReturnType)returnType=block.getReturnType();returnType=Blockly.mbed.getmbedType_(returnType);var functionName=tickName+"_handle";var code=returnType+
" "+functionName+"("+args.join(", ")+") {\n"+branch+returnValue+"}";Blockly.mbed.userFunctions_[functionName]=code;Blockly.mbed.addDeclaration(tickName,"Ticker "+tickName+";");var attach_code=tickName+".attach"+"(\x26"+functionName+","+ticks+");\n";return attach_code};Blockly.mbed.tone={};Blockly.mbed["io_tone"]=function(block){var pin=block.getFieldValue("TONEPIN");var freq=Blockly.mbed.valueToCode(block,"FREQUENCY",Blockly.mbed.ORDER_ATOMIC);Blockly.mbed.reservePin(block,pin,Blockly.mbed.PinTypes.OUTPUT,"Tone Pin");var pinSetupCode="pinMode("+pin+", OUTPUT);\n";Blockly.mbed.addSetup("io_"+pin,pinSetupCode,false);var code="tone("+pin+","+freq+");\n";return code};
Blockly.mbed["io_notone"]=function(block){var pin=block.getFieldValue("TONEPIN");Blockly.mbed.reservePin(block,pin,Blockly.mbed.PinTypes.OUTPUT,"Tone Pin");var pinSetupCode="pinMode("+pin+", OUTPUT);\n";Blockly.mbed.addSetup("io_"+pin,pinSetupCode,false);var code="noTone("+pin+");\n";return code};Blockly.mbed.variables={};Blockly.mbed["variables_declare_array"]=Blockly.mbed["variables_declare"]=function(block){return""};Blockly.mbed["variables_get"]=function(block){var code=Blockly.mbed.getVariableName(block,block.getFieldValue("VAR"),Blockly.Variables.NAME_TYPE);return[code,Blockly.mbed.ORDER_ATOMIC]};
Blockly.mbed["variables_set"]=function(block){var argument0=Blockly.mbed.valueToCode(block,"VALUE",Blockly.mbed.ORDER_ASSIGNMENT)||"0";var varName=Blockly.mbed.getVariableName(block,block.getFieldValue("VAR"),Blockly.Variables.NAME_TYPE);return varName+" \x3d "+argument0+";\n"};
Blockly.mbed["variables_set_type"]=function(block){var varName=Blockly.mbed.getVariableName(block,block.getFieldValue("VARNAME"),Blockly.Variables.NAME_TYPE);var varType=Blockly.mbed.getVariableType(block,block.getFieldValue("VARNAME"));var targetType=Blockly.Types[block.getFieldValue("VARIABLE_SETTYPE_TYPE")];if(targetType.typeId==varType.typeId)return[varName,Blockly.mbed.ORDER_ATOMIC];var code="("+Blockly.mbed.getmbedType_(targetType)+")("+varName+")";if(varType.typeId==Blockly.Types.ARRAY.typeId)switch(targetType.typeId){case Blockly.Types.TEXT.typeId:code=
Blockly.mbed.getmbedType_(targetType)+"("+varName+")";break;case Blockly.Types.BOOLEAN.typeId:case Blockly.Types.CHARACTER.typeId:case Blockly.Types.SHORT_NUMBER.typeId:code=Blockly.mbed.getmbedType_(targetType)+"(atoi("+varName+"))";break;case Blockly.Types.NUMBER.typeId:code="atoi("+varName+")";break;case Blockly.Types.LARGE_NUMBER.typeId:code="atol("+varName+")";break;case Blockly.Types.DECIMAL.typeId:code="float(atof("+varName+"))";break}else if(varType.typeId==Blockly.Types.TEXT.typeId)switch(targetType.typeId){case Blockly.Types.ARRAY.typeId:code=
"("+varName+".c_str())";break;case Blockly.Types.BOOLEAN.typeId:case Blockly.Types.CHARACTER.typeId:case Blockly.Types.SHORT_NUMBER.typeId:code=Blockly.mbed.getmbedType_(targetType)+"(std::stoi("+varName+"))";break;case Blockly.Types.NUMBER.typeId:code="std::stoi("+varName+")";break;case Blockly.Types.LARGE_NUMBER.typeId:code="std::stol("+varName+")";break;case Blockly.Types.DECIMAL.typeId:code="std::stof("+varName+")";break}else if(targetType.typeId==Blockly.Types.TEXT.typeId)code="std::to_string("+
varName+")";Blockly.mbed.addInclude("converters",'#include "converters.h"');return[code,Blockly.mbed.ORDER_ATOMIC]};